<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>教练端 · TXT 订课</title>
<style>
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#f6f7fb;color:#111}
  .wrap{max-width:1000px;margin:24px auto;padding:0 16px}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 6px 18px #00000012;padding:16px;margin-bottom:16px}
  input,button{padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px}
  button{background:#111;color:#fff;cursor:pointer}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid #eee;font-size:14px}
  th{font-weight:600;color:#374151;background:#fafafa}
  .status-pending{background:#FCE7C7}
  .status-scheduled{background:#E5E7EB}
  .status-done{background:#D1FAE5}
  .muted{color:#6b7280}
</style>
</head>
<body>
<div class="wrap">
  <h1>教练端 · TXT 订课</h1>

  <div class="card">
    <h3>登录（coach_id + coach_email）</h3>
    <input id="cid" placeholder="coach_id" />
    <input id="cem" placeholder="coach_email" />
    <button id="loginBtn" onclick="login()">登录</button>
    <button onclick="refresh()">刷新</button>
    <div id="info" style="margin-top:8px;color:#10b981"></div>
  </div>

  <div id="sess" class="card" style="display:none">
    <h3>我的课程</h3>
    <table id="tbl"><thead>
      <tr>
        <th>session_id</th>
        <th>日期（周）</th>
        <th>时间</th>
        <th>客户</th>
        <th>时长(h)</th>
        <th>状态</th>
        <th>操作</th>
      </tr>
    </thead><tbody></tbody></table>
  </div>
</div>

<script>
// === 把你的 Apps Script Web App /exec 地址填在这里 ===
const API_BASE = 'https://script.google.com/macros/s/AKfycbz8KsBS6wH3vUjtAQ5A-dLWRWKlzYlgvvYIIkQYGD23Ue3Vk7FSHII1d8ko8s2oKL33Zw/exec';

// —— 封装 POST：使用 text/plain 避免 CORS 预检（OPTIONS）——
async function post(action, payload = {}) {
  try {
    const res = await fetch(API_BASE, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' }, // simple request
      body: JSON.stringify({ action, ...payload })
    });
    return await res.json();
  } catch (err) {
    console.error('POST error', err);
    alert('网络错误：' + err.message);
    return { ok:false, msg:'Network error' };
  }
}

let coach = null;

// ======= 日期/时间格式化工具 =======
const weekdayCN = ['周日','周一','周二','周三','周四','周五','周六'];
function isValidDate(d){ return d instanceof Date && !isNaN(d.getTime()); }

function formatDateWithWeek(x){
  if(!x) return '';
  let d;
  if(typeof x === 'number') d = new Date(x);
  else if(typeof x === 'string') d = new Date(x);
  else if(x instanceof Date) d = x;
  if(!isValidDate(d)) return String(x);
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  const wk = weekdayCN[d.getDay()];
  return `${y}-${m}-${day}（${wk}）`;
}

function formatTimeHHmm(x){
  if(!x) return '';
  if(typeof x === 'string' && /^\d{1,2}:\d{2}(:\d{2})?$/.test(x.trim())){
    return x.trim().slice(0,5);
  }
  let d;
  if(typeof x === 'number') d = new Date(x);
  else if(typeof x === 'string') d = new Date(x);
  else if(x instanceof Date) d = x;
  if(!isValidDate(d)) return String(x);
  const hh = String(d.getHours()).padStart(2,'0');
  const mm = String(d.getMinutes()).padStart(2,'0');
  return `${hh}:${mm}`;
}

// ======= 客户姓名缓存与拉取 =======
const clientNameCache = new Map(); // id -> full_name

function fillClientNamesFromMap(mapObj){
  if(mapObj && typeof mapObj === 'object'){
    for(const [id, name] of Object.entries(mapObj)){
      if(id && name) clientNameCache.set(String(id), String(name));
    }
  }
}

/** 批量获取缺失的 client name，优先用后端批量接口，其次逐个查询 */
async function hydrateMissingClientNames(missingIds){
  const ids = [...new Set(missingIds.filter(Boolean).map(String))].filter(id=>!clientNameCache.has(id));
  if(ids.length === 0) return;

  // 1) 优先尝试批量接口：client_names
  try{
    const r = await post('client_names', { ids });
    if(r && r.ok && r.map){
      fillClientNamesFromMap(r.map);
      return;
    }
  }catch(e){ /* 忽略，转入逐个查询 */ }

  // 2) 逐个查询：client_name_by_id
  const chunk = async (arr, size=5)=>{
    for(let i=0;i<arr.length;i+=size){
      const group = arr.slice(i,i+size);
      await Promise.all(group.map(async id=>{
        if(clientNameCache.has(id)) return;
        try{
          const r = await post('client_name_by_id', { id });
          if(r && r.ok && r.name){
            clientNameCache.set(id, String(r.name));
          }
        }catch(e){}
      }));
    }
  };
  await chunk(ids, 5);
}

/** 从 session 记录中读取客户名（带缓存与回退） */
function displayClientName(s){
  const direct = s.client_name || s.client_full_name || s.client || '';
  if(direct) return direct;
  const id = String(s.client_id || s.clientId || s.clientID || '').trim();
  if(!id) return '';
  if(clientNameCache.has(id)) return clientNameCache.get(id);
  return id; // 先占位 id，待补全后二次渲染
}

// —— 登录 ——
async function login(){
  const btn = document.getElementById('loginBtn');
  btn.disabled = true;
  try{
    const coach_id = document.getElementById('cid').value.trim();
    const coach_email = document.getElementById('cem').value.trim();
    const r = await post('login_coach', { coach_id, coach_email });
    if(!r.ok){ alert(r.msg || '登录失败'); return; }

    coach = r.coach;
    document.getElementById('info').textContent = `${coach.coach_name} (${coach.coach_id}) 已登录`;
    localStorage.setItem('TXT_COACH', JSON.stringify({ coach_id, coach_email }));

    if(r.clientMap) fillClientNamesFromMap(r.clientMap);

    const sessions = r.sessions || [];
    document.getElementById('sess').style.display = 'block';
    render(sessions);

    const missingIds = sessions.map(s => s.client_id || s.clientId || s.clientID).filter(Boolean);
    await hydrateMissingClientNames(missingIds);
    render(sessions); // 二次渲染补齐姓名
  } finally {
    btn.disabled = false;
  }
}
window.login = login;

// —— 刷新 ——
async function refresh(){
  const saved = localStorage.getItem('TXT_COACH');
  if(!saved) return alert('请先登录');
  const { coach_id, coach_email } = JSON.parse(saved);
  const r = await post('login_coach', { coach_id, coach_email });
  if(!r.ok) return alert(r.msg || '刷新失败');

  if(r.clientMap) fillClientNamesFromMap(r.clientMap);

  const sessions = r.sessions || [];
  render(sessions);

  const missingIds = sessions.map(s => s.client_id || s.clientId || s.clientID).filter(Boolean);
  await hydrateMissingClientNames(missingIds);
  render(sessions);
}
window.refresh = refresh;

// —— 渲染表格 ——
function render(list){
  const tb = document.querySelector('#tbl tbody'); tb.innerHTML='';
  list.forEach(s=>{
    const tr = document.createElement('tr');
    tr.className = 'status-'+(s.status||'');
    const dateDisp = formatDateWithWeek(s.date || s.session_date);
    const timeDisp = formatTimeHHmm(s.time || s.session_time);
    const clientName = displayClientName(s);

    tr.innerHTML = `
      <td>${s.session_id || ''}</td>
      <td>${dateDisp}</td>
      <td>${timeDisp}</td>
      <td>${clientName}</td>
      <td>${s.duration_hours ?? s.duration ?? 1}</td>
      <td>${s.status || ''}</td>
      <td>${s.status==='pending'
        ? `<button onclick="confirmSess('${s.session_id}')">确认</button>` : ''}</td>`;
    tb.appendChild(tr);
  });
}

// —— 确认预约（pending -> scheduled） ——
async function confirmSess(id){
  const r = await post('confirm_session', { session_id:id });
  if(!r.ok) return alert(r.msg || '失败');
  alert('已确认，状态为待完成');
  refresh();
}
window.confirmSess = confirmSess;

// —— 自动恢复登录 —— 
(function autoLogin(){
  const saved = localStorage.getItem('TXT_COACH');
  if(!saved) return;
  const { coach_id, coach_email } = JSON.parse(saved);
  if(coach_id && coach_email){
    post('login_coach', { coach_id, coach_email }).then(async r=>{
      if(!r || !r.ok) return;
      coach = r.coach;
      document.getElementById('info').textContent = `${coach.coach_name} (${coach.coach_id}) 已登录`;
      document.getElementById('sess').style.display = 'block';
      if(r.clientMap) fillClientNamesFromMap(r.clientMap);
      const sessions = r.sessions || [];
      render(sessions);
      const missingIds = sessions.map(s => s.client_id || s.clientId || s.clientID).filter(Boolean);
      await hydrateMissingClientNames(missingIds);
      render(sessions);
    });
  }
})();
</script>
</body>
</html>
