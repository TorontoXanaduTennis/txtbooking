<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>教练端 · TXT 订课</title>

<!-- ===== 基础样式（教练端） ===== -->
<style>
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#f6f7fb;color:#111}
  .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 6px 18px #00000012;padding:16px;margin-bottom:16px}
  .title{font-size:22px;margin:0 0 8px}
  .muted{color:#6b7280}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .btn{padding:8px 12px;border:1px solid #e5e7eb;border-radius:10px;background:#111;color:#fff;cursor:pointer}
  .btn-secondary{padding:8px 12px;border:1px solid #e5e7eb;border-radius:10px;background:#6b7280;color:#fff;cursor:pointer}
  .btn-ok{background:#10b981}
  .btn-danger{background:#ef4444}
  input,select,button{font:inherit}
  .pill{display:inline-block;padding:4px 8px;border:1px solid #e5e7eb;border-radius:999px;background:#fff}
  .table-wrap{position:relative;overflow:auto}
  table{width:100%;border-collapse:separate;border-spacing:0 8px}
  thead th{position:sticky;top:0;background:#f6f7fb;z-index:1;font-weight:600;padding:8px;white-space:nowrap}
  tbody tr{background:#fff;box-shadow:0 8px 20px rgba(0,0,0,.08)}
  th,td{padding:8px 10px;font-size:14px;white-space:nowrap}
  tbody tr td:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px}
  tbody tr td:last-child{border-top-right-radius:10px;border-bottom-right-radius:10px}
  .w-date{max-width:160px}
  .w-time{max-width:90px}
  .w-coach{max-width:140px}
  .w-id{max-width:200px}
  .w-ops{min-width:220px}

  /* Google Calendar 样式（保持原样） */
  #gcal-wrap * { box-sizing: border-box; }
  #gcal-wrap .bar{display:flex;gap:8px;align-items:center}
  #gcal-wrap .right{margin-left:auto;display:flex;gap:8px;align-items:center}
  #gcal-wrap .help{font-size:12px;color:#6b7280}
  #gcal-calendar{width:100%}
  #gcal-wrap button{padding:8px 12px;border:1px solid #e5e7eb;border-radius:8px;background:#fff;cursor:pointer;color:#111}
  #gcal-wrap select{padding:6px 8px;border:1px solid #e5e7eb;border-radius:8px;background:#fff}
  #gcal-picker .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  #gcal-picker .list{display:flex;gap:10px;flex-wrap:wrap;margin-top:6px}
  #gcal-picker .item{display:flex;align-items:center;gap:6px;font-size:12px;border:1px dashed #e5e7eb;padding:3px 8px;border-radius:8px;background:#fff}
  #gcal-picker .item input{transform:translateY(1px)}
  #gcal-legend{display:flex;gap:10px;flex-wrap:wrap;margin-top:6px}
  #gcal-legend .pill{display:flex;align-items:center;gap:6px;border:1px solid #e5e7eb;border-radius:999px;padding:2px 8px;background:#fff;font-size:12px}
  #gcal-legend .sw{width:10px;height:10px;border-radius:3px;border:1px solid #00000022}
  #gcal-picker .sw{width:10px;height:10px;border-radius:3px;border:1px solid #00000022}
</style>

<link id="gcal-fc-css" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.min.css" rel="stylesheet" />
<script>
(function ensureFullCalendarCSS(){
function loaded(l){ try{ return !!l.sheet && l.sheet.cssRules!==null; }catch(e){ return !!l.sheet; } }
function swap(){
const l=document.getElementById('gcal-fc-css');
const tried=l.getAttribute('data-tried')||'';
if(!tried.includes('jsdelivr')){
l.href="https://unpkg.com/fullcalendar@6.1.19/index.min.css";
l.setAttribute('data-tried', tried+' jsdelivr');
setTimeout(swap, 4000);
}else if(!tried.includes('unpkg')){
l.href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.9/index.min.css";
l.setAttribute('data-tried', tried+' unpkg');
}
}
setTimeout(()=>{ const l=document.getElementById('gcal-fc-css'); if(!loaded(l)) swap(); }, 5000);
})();
</script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.js"></script>
<!-- Google 登录 -->
<script src="https://accounts.google.com/gsi/client" async defer></script>
<!-- Google Calendar API -->
<script src="https://apis.google.com/js/api.js"></script>
</head>

<body>
<div class="wrap">
  <h1 class="title">教练端 · TXT 订课</h1>

  <!-- 顶部工具条：登录 + 刷新 + 退出 -->
  <div class="card">
    <div class="toolbar">
      <!-- Google 一体化按钮（保持原样） -->
      <div id="g_id_onload"
           data-client_id="126117723960-3gdibqblicp6ncc0jiuv9pu8frgmhs5n.apps.googleusercontent.com"
           data-auto_prompt="false"
           data-callback="onCoachGoogleCredential"></div>
      <div class="g_id_signin" data-type="standard" data-size="large" data-shape="rectangular" data-theme="outline"></div>

      <button class="btn-secondary" onclick="coachGooglePrompt()">使用弹窗登录</button>
      <button class="btn-secondary" onclick="refresh()">刷新</button>
      <button class="btn-secondary" id="btnLogout" onclick="coachSignOut()" style="display:none">退出登录</button>
      <span id="info" style="color:#10b981;margin-left:auto"></span>
      <span id="opMsg" style="margin-left:12px;color:#10b981;"></span>
    </div>
    <div class="muted" style="margin-top:6px;font-size:12px">请使用被授权的 Google 账号登录。</div>
  </div>

  <!-- Google 日历（登录后显示；初始隐藏） -->
  <div class="card" id="gcal-wrap" style="display:none">
    <div class="bar">
      <strong>球馆日历</strong>
      <div class="right">
        <button id="gcal-signin">Google 登录日历</button>
        <button id="gcal-signout" style="display:none;">退出</button>
        <button id="gcal-refreshBtn" style="display:none;">刷新</button>
        <span id="gcal-status" class="help">未登录</span>
      </div>
    </div>

    <div id="gcal-picker" class="card" style="padding:10px;margin:12px 0;display:none;">
      <div class="row">
        <div class="help">选择要显示的日历（可多选；只读也可显示）：</div>
        <button id="gcal-checkAll" class="help">全选</button>
        <button id="gcal-uncheckAll" class="help">全不选</button>
        <select id="gcal-writeCal" title="写入目标（只列可写）" style="display:none;"></select>
        <div class="help">当前写入目标：<code id="gcal-currCal">primary</code></div>
      </div>
      <div id="gcal-calList" class="list"></div>
      <div id="gcal-legend"></div>
    </div>

    <div id="gcal-calendar"></div>

    <div id="gcal-diag" class="card" style="padding:10px;display:none;">
      <b>诊断</b>
      <pre id="gcal-diagText"></pre>
    </div>
  </div>

  <!-- 即将到来的课程（保持原样） -->
  <div class="card" id="upcoming">
    <h3>即将到来的课程</h3>
    <div class="table-wrap">
      <table>
        <thead>
        <tr>
          <th class="w-date">date</th>
          <th class="w-time">time</th>
          <th>duration</th>
          <th class="w-coach">client</th>
          <th>status</th>
          <th>备注</th>
          <th class="w-ops">操作</th>
          <th class="w-id">session_id</th>
        </tr>
        </thead>
        <tbody id="tblUpcoming"></tbody>
      </table>
    </div>
  </div>

  <!-- 新增：临时取消 / No Show（只读） -->
  <div class="card" id="cancelNoShow" style="display:none">
    <h3>临时取消 / No Show（只读）</h3>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th class="w-date">date</th><th class="w-time">time</th><th>duration</th><th class="w-coach">client</th>
            <th>coach</th><th>status</th><th class="w-id">session_id</th>
          </tr>
        </thead>
        <tbody id="tblCancelNoShow"></tbody>
      </table>
    </div>
  </div>

  <!-- 已完成（保持原样；现包含 No Show） -->
  <div class="card" id="done">
    <h3 style="display:flex;justify-content:space-between;align-items:center">
      <span>已完成课程</span>
      <span class="toolbar">
        <button class="btn-secondary" id="donePrev" onclick="pageDone(-1)">上一页</button>
        <span id="donePageInfo" class="muted"></span>
        <button class="btn-secondary" id="doneNext" onclick="pageDone(1)">下一页</button>
      </span>
    </h3>
    <div class="table-wrap">
      <table>
        <thead>
        <tr>
          <th class="w-date">date</th>
          <th class="w-time">time</th>
          <th>duration</th>
          <th class="w-coach">client</th>
          <th>status</th>
          <th>备注</th>
          <th>反馈</th>
          <th class="w-ops">提交</th>
          <th class="w-id">session_id</th>
        </tr>
        </thead>
        <tbody id="tblDone"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
/* === Apps Script /exec === */
const API_BASE = 'https://script.google.com/macros/s/AKfycbzIRAc4FhAGl_v-1m59lbHg4zl5Kth6z-1TIuM4en2CS0i8fBV26b5Gi-c0wNL1LPawyA/exec';

/* ==== Google 身份 / 本地会话（保持登录态） ==== */
let COACH_ID_TOKEN = null;
const COACH_TOKEN_KEY = 'TXT_COACH_ID_TOKEN';
function coachToken(){ try{return localStorage.getItem(COACH_TOKEN_KEY)||'';}catch(e){return '';} }
function setCoachToken(t){ try{ if(t){ localStorage.setItem(COACH_TOKEN_KEY, t); COACH_ID_TOKEN = t; } }catch(e){} }
function clearCoachToken(){ try{ localStorage.removeItem(COACH_TOKEN_KEY); }catch(e){} COACH_ID_TOKEN = null; }

/* ==== 统一 POST（自动附带 id_token）==== */
async function post(action, payload = {}){
  try{
    const t = coachToken();
    if (t && !payload.id_token) payload.id_token = t;
    const res = await fetch(API_BASE, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify({ action, ...payload })
    });
    return await res.json();
  }catch(err){
    console.error('POST error', err);
    return { ok:false, msg:'Network error' };
  }
}

/* ==== 工具：日期/时间格式化（保持原逻辑） ==== */
function parseMaybeDate(x){
  if(x==null||x==='') return null;
  if(Object.prototype.toString.call(x)==='[object Date]'&&!isNaN(x)) return x;
  if(typeof x==='number'){
    const base=Date.UTC(1899,11,30); return new Date(base + x*86400000);
  }
  if(typeof x==='string'){
    if(/^\d{1,2}:\d{2}/.test(x)){ const [h,m]=x.split(':').map(Number); const d=new Date(); d.setHours(h,m||0,0,0); return d; }
    const d=new Date(x); if(!isNaN(d)) return d;
  }
  return null;
}
function weekdayCN(d){ return ['周日','周一','周二','周三','周四','周五','周六'][d.getDay()]; }
function formatDateWithWeek(x){ const d=parseMaybeDate(x); if(!d) return x||''; const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${dd}（${weekdayCN(d)}）`; }
function formatTimeHHmm(x){ const d=parseMaybeDate(x); return d?d.toTimeString().slice(0,5):(x||''); }
function sessionStartEnd(s){
  const d=parseMaybeDate(s.date), t=parseMaybeDate(s.time);
  if(!d||!t) return {start:null,end:null};
  const start=new Date(d.getFullYear(), d.getMonth(), d.getDate(), t.getHours(), t.getMinutes(), 0, 0);
  const dur=Number(s.duration_hours||1)||1;
  const end=new Date(start.getTime() + dur*3600*1000);
  return {start,end};
}

/* ==== 客户名字缓存（保持原样） ==== */
window.CLIENT_NAME_MAP = window.CLIENT_NAME_MAP || {};
function fillClientNamesFromMap(map){
  try{ Object.assign(window.CLIENT_NAME_MAP, map||{}); }catch(_){}
}

/* ==== Google 登录回调（保持 UI，加入本地存储 & 自动刷新） ==== */
async function onCoachGoogleCredential(resp){
  try{
    const id_token = resp && resp.credential;
    if (!id_token){ alert('Google 登录失败：未拿到 id_token'); return; }
    setCoachToken(id_token);
    const r = await post('login_coach', {});
    if(!r || !r.ok){ alert((r&&r.msg)||'登录失败'); return; }
    coach = r.coach || {};
    document.getElementById('info').textContent = `${coach.coach_name||''} (${coach.coach_id||''}) 已登录`;
    const btnL = document.getElementById('btnLogout'); if(btnL) btnL.style.display='';
    const gcal = document.getElementById('gcal-wrap'); if(gcal) gcal.style.display='';
    if(r.clientMap) fillClientNamesFromMap(r.clientMap);
    renderAll(r.sessions||[]);
  }catch(e){
    console.error(e);
    alert('登录异常：'+e.message);
  }
}
function coachGooglePrompt(){
  try{
    google.accounts.id.initialize({
      client_id:'126117723960-3gdibqblicp6ncc0jiuv9pu8frgmhs5n.apps.googleusercontent.com',
      callback:onCoachGoogleCredential
    });
    google.accounts.id.prompt();
  }catch(e){
    alert('无法打开 Google 登录：'+e);
  }
}

/* 退出登录按钮 */
function coachSignOut(){ clearCoachToken(); location.reload(); }

/* ==== 刷新（保持外观；无需重新登录） ==== */
async function refresh(){
  const t = coachToken();
  if(!t){
    alert('请先用 Google 登录');
    return;
  }
  COACH_ID_TOKEN = t;
  const r = await post('login_coach', {}); // 自动注入 id_token
  if(!r || !r.ok){ alert((r&&r.msg)||'刷新失败'); return; }

  coach = r.coach || {};
  document.getElementById('info').textContent = `${coach.coach_name||''} (${coach.coach_id||''}) 已登录`;
  const btnL = document.getElementById('btnLogout'); if(btnL) btnL.style.display='';
  const gcal = document.getElementById('gcal-wrap'); if(gcal) gcal.style.display='';

  if(r.clientMap) fillClientNamesFromMap(r.clientMap);

  const sessions = r.sessions || [];
  renderAll(sessions);

  const missingIds = sessions.map(s => s.client_id || s.clientId || s.clientID).filter(Boolean);
  ensureClientNames(missingIds);
}
window.refresh = refresh;

/* ======= 主渲染：分组 + 排序（保持你的逻辑，仅补充状态别名） ======= */
let DONE_LIST=[]; let DONE_PAGE=1; const DONE_PAGE_SIZE=10;
function renderAll(list){
  const now = Date.now();
  const withStart = (list||[]).map(s=>{
    const {start,end} = sessionStartEnd(s);
    return Object.assign({}, s, { start, end });
  });

  // 即将到来（未来） + 保留 pending / scheduled / coach_proposed / cancelled / canceled / canceled_by_client
  const upcoming = withStart.filter(x=>{
    const st = x.start?.getTime();
    const future = st ? st>=now : true;
    return future && (x.status==='pending' || x.status==='scheduled' || x.status==='coach_proposed' || x.status==='cancelled' || x.status==='canceled' || x.status==='canceled_by_client');
  }).sort((a,b)=> (a.start?.getTime()||0) - (b.start?.getTime()||0));
  renderUpcoming(upcoming);

  // 已完成 + No Show（scheduled 且已过期）
  const done = withStart.filter(x=>x.status==='done' && x.start);
  const noShows = withStart.filter(x=>x.status==='scheduled' && x.end && x.end.getTime() < now);
  const doneExpanded = done.concat(noShows.map(s=>({...s, status:'no_show'})));
  const doneSorted = doneExpanded.sort((a,b)=> (b.start?.getTime()||0) - (a.start?.getTime()||0));
  renderDone(doneSorted, DONE_PAGE);
  renderCancelNoShow(withStart);
}

/* —— 即将到来的 —— */
function renderUpcoming(rows){
  const tb = document.getElementById('tblUpcoming'); tb.innerHTML='';
  rows.forEach(s=>{
    const name = (window.CLIENT_NAME_MAP && window.CLIENT_NAME_MAP[s.client_id]) ? window.CLIENT_NAME_MAP[s.client_id] : (s.client_id||'');
    const tr = document.createElement('tr');
    const note = (s.notes||'').replace(/"/g,'&quot;');
    tr.innerHTML = `
      <td class="w-date">${formatDateWithWeek(s.date)}</td>
      <td class="w-time">${formatTimeHHmm(s.time)}</td>
      <td>${s.duration_hours||1} hr</td>
      <td class="w-coach">${name}</td>
      <td>${s.status||''}</td>
      <td><input class="note" data-id="${s.session_id}" value="${note}" /></td>
      <td class="w-ops">
        <button class="btn-ok" onclick="confirmSess('${s.session_id}')">确认</button>
      </td>
      <td class="w-id">${s.session_id}</td>
    `;
    tb.appendChild(tr);
  });
}

/* —— 已完成（分页） —— */
function pageDone(delta){
  const totalPages = Math.max(1, Math.ceil(DONE_LIST.length / DONE_PAGE_SIZE));
  DONE_PAGE = Math.min(totalPages, Math.max(1, DONE_PAGE + delta));
  renderDone(DONE_LIST, DONE_PAGE);
}
function renderDone(all, page){
  DONE_LIST = all || [];
  const totalPages = Math.max(1, Math.ceil(DONE_LIST.length / DONE_PAGE_SIZE));
  const s=(page-1)*DONE_PAGE_SIZE, e=s+DONE_PAGE_SIZE;
  const list = DONE_LIST.slice(s,e);

  const tb=document.getElementById('tblDone'); tb.innerHTML='';
  list.forEach(s=>{
    const name = (window.CLIENT_NAME_MAP && window.CLIENT_NAME_MAP[s.client_id]) ? window.CLIENT_NAME_MAP[s.client_id] : (s.client_id||'');
    const note = (s.notes||'').replace(/"/g,'&quot;');
    const fb   = (s.feedback||'').replace(/"/g,'&quot;');
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td class="w-date">${formatDateWithWeek(s.date)}</td>
      <td class="w-time">${formatTimeHHmm(s.time)}</td>
      <td>${s.duration_hours||1} hr</td>
      <td class="w-coach">${name}</td>
      <td>${s.status||'done'}</td>
      <td><input class="note" data-id="${s.session_id}" value="${note}"></td>
      <td><input class="fb" data-id="${s.session_id}" value="${fb}"></td>
      <td><button class="btn" onclick="submitRow('${s.session_id}','${s.status||'done'}')">提交</button></td>
      <td class="w-id">${s.session_id}</td>
    `;
    tb.appendChild(tr);
  });

  document.getElementById('donePageInfo').textContent = `第 ${page} / 共 ${totalPages} 页（每页 10）`;
  document.getElementById('donePrev').disabled = page<=1;
  document.getElementById('doneNext').disabled = page>=totalPages;
}

/* —— 新增：临时取消 / No Show（只读列表） —— */
function normStatusName(s){
  const x = String(s||'').toLowerCase();
  if (x==='cancelled' || x==='canceled') return 'canceled';
  return x;
}
function renderCancelNoShow(withStart){
  const nowMs = Date.now();
  const H24 = 24*3600*1000;
  const rows = [];
  (withStart||[]).forEach(s=>{
    const st = s.start, en = s.end;
    const stMs = st ? st.getTime() : NaN;
    const enMs = en ? en.getTime() : NaN;
    const ns = normStatusName(s.status);
    if ((ns==='canceled' || ns==='canceled_by_client') && st && Math.abs(stMs - nowMs) <= H24){
      rows.push(Object.assign({_kind:'临时取消'}, s));
    }else if (ns==='scheduled' && en && enMs < nowMs){
      const cp = Object.assign({}, s);
      cp.status = 'no_show';
      cp._kind = 'No Show';
      rows.push(cp);
    }
  });
  const tb = document.getElementById('tblCancelNoShow');
  const card = document.getElementById('cancelNoShow');
  if(!tb || !card) return;
  tb.innerHTML = '';
  if (!rows.length){ card.style.display='none'; return; }
  card.style.display = '';
  rows.sort((a,b)=> (a.start?.getTime()||0) - (b.start?.getTime()||0));
  rows.forEach(s=>{
    const tr = document.createElement('tr');
    const clientName = (window.CLIENT_NAME_MAP && window.CLIENT_NAME_MAP[s.client_id]) ? window.CLIENT_NAME_MAP[s.client_id] : (s.client_id||'');
    tr.innerHTML = `
      <td class="w-date">${formatDateWithWeek(s.date)}</td>
      <td class="w-time">${formatTimeHHmm(s.time)}</td>
      <td>${s.duration_hours||1} hr</td>
      <td class="w-coach">${clientName}</td>
      <td>${s.coach_name||''}</td>
      <td>${s._kind||s.status||''}</td>
      <td class="w-id">${s.session_id||''}</td>
    `;
    tb.appendChild(tr);
  });
}

/* ===== 教练确认（修复：admin required） ===== */
async function confirmSess(id){
  const r = await post('coach_confirm_session', { session_id:id });
  if(!r || !r.ok){ alert((r&&r.msg)||'操作失败'); return; }
  const msg = document.getElementById('opMsg');
  if (msg){ msg.style.color='#10b981'; msg.textContent='已确认该课程'; setTimeout(()=>{ msg.textContent=''; },1500); }
  refresh();
}
window.confirmSess = confirmSess;

/* ==== 兼容提交备注/反馈（保持原逻辑） ==== */
async function updateNotesCompat(base){
  const actions = [
    'update_session_notes','update_session_feedback','update_notes','update_feedback',
    'update_session','update_session_v2','update_session_fields','update_session_meta',
    'save_session','set_session','set_session_fields','update_session_info',
    'update_client_session','client_update_session','client_update_notes',
    'client_set_session','client_save_session',
    'mutate_session','patch_session','edit_session_notes','set_session_notes','save_session_notes'
  ];
  const idKeys   = ['session_id','id','sid'];
  const noteKeys = ['notes','client_notes','note','remark'];
  const fbKeys   = ['feedback','client_feedback','fb',''];
  const shapes = [
    (p, idk, nk, fk) => Object.assign({ [idk]:p.session_id, [nk]:p.notes }, fk?{[fk]:p.feedback}:{}),
    (p, idk, nk, fk) => { const fields = Object.assign({[nk]:p.notes}, fk?{[fk]:p.feedback}:{}); return { [idk]:p.session_id, fields }; },
    (p, idk, nk, fk) => { const data = Object.assign({[idk]:p.session_id, [nk]:p.notes}, fk?{[fk]:p.feedback}:{}); return { data }; },
    (p, idk, nk, fk) => { const updates = Object.assign({[nk]:p.notes}, fk?{[fk]:p.feedback}:{}); return { [idk]:p.session_id, updates }; },
    (p, idk, nk, fk) => { const patch = Object.assign({[nk]:p.notes}, fk?{[fk]:p.feedback}:{}); return { [idk]:p.session_id, patch }; },
    (p, idk, nk, fk) => { const session = Object.assign({[idk]:p.session_id, [nk]:p.notes}, fk?{[fk]:p.feedback}:{}); return { session }; }
  ];
  for (const act of actions){
    for (const idk of idKeys){
      for (const nk of noteKeys){
        for (const fk of fbKeys){
          for (const build of shapes){
            const payload = build(base, idk, nk, fk);
            payload.action = act; payload.source = 'coach_ui';
            const r = await post(act, payload);
            if (r && r.ok) return r;
          }
        }
      }
    }
  }
  return { ok:false, msg:'All tries failed' };
}
async function submitRow(id, status){
  const noteEl = document.querySelector(`.note[data-id='${id}']`);
  const fbEl   = document.querySelector(`.fb[data-id='${id}']`);
  const btn    = document.querySelector(`button.btn[onclick*="${id}"]`);
  const notes = noteEl ? noteEl.value : '';
  const feedback = fbEl ? fbEl.value : '';

  btn.disabled = true;
  const r = await updateNotesCompat({ session_id:id, notes, feedback });
  btn.disabled = false;

  const msg = document.getElementById('opMsg');
  if(!r.ok){
    if (msg){ msg.style.color='#ef4444'; msg.textContent='提交失败'; setTimeout(()=>{ msg.textContent=''; },1500); }
    return;
  }
  if (msg){ msg.style.color='#10b981'; msg.textContent='提交成功'; setTimeout(()=>{ msg.textContent=''; },1200); }
}

/* =========================
Google Calendar（保持原有逻辑）
========================= */
const GCAL_CLIENT_ID = "126117723960-3gdibqblicp6ncc0jiuv9pu8frgmhs5n.apps.googleusercontent.com";
const GCAL_SCOPES = "https://www.googleapis.com/auth/calendar.readonly https://www.googleapis.com/auth/calendar.events";
const GCAL_TZ = "America/Toronto";
const GCAL_FETCH_BUFFER_MS = 36 * 60 * 60 * 1000;

let gcal_tokenClient, gcal_accessToken=null, gapiReady=false, gisReady=false, gcal_calendar;
let calendarListCache=[], showCalendarIds=new Set(), writeCalendarId="primary";

function gcalShowDiag(obj){
  const b=document.getElementById('gcal-diag');
  const p=document.getElementById('gcal-diagText');
  b.style.display='';
  try{ p.textContent=(typeof obj==='string')?obj:JSON.stringify(obj,null,2); }
  catch(e){ p.textContent=String(obj); }
}
function gapiLoaded(){ gapi.load('client', async ()=>{ await gapi.client.init({discoveryDocs:["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"]}); gapiReady=true; }); }
function gisLoaded(){ gcal_tokenClient=google.accounts.oauth2.initTokenClient({
  client_id:GCAL_CLIENT_ID, scope:GCAL_SCOPES,
  callback:(resp)=>{ if(resp&&resp.access_token){ gcal_accessToken=resp.access_token; gapi.client.setToken({access_token:gcal_accessToken}); gcalOnSignedIn(); } else { gcalShowDiag({oauth_callback_resp:resp}); } }
}); gisReady=true; }
window.gapiLoaded=gapiLoaded; window.gisLoaded=gisLoaded;

async function gcalSignIn(){ if(!gapiReady||!gisReady) return; gcal_tokenClient.requestAccessToken({prompt:'consent'}); }
function gcalSignOut(){ if(!gcal_accessToken) return; google.accounts.oauth2.revoke(gcal_accessToken,()=>{
  gcal_accessToken=null; gapi.client.setToken(null);
  document.getElementById('gcal-signin').style.display='';
  document.getElementById('gcal-signout').style.display='none';
  document.getElementById('gcal-refreshBtn').style.display='none';
  document.getElementById('gcal-status').textContent='未登录';
  document.getElementById('gcal-writeCal').style.display='none';
  document.getElementById('gcal-picker').style.display='none';
  if(gcal_calendar) gcal_calendar.destroy();
});}
document.getElementById('gcal-signin').onclick=gcalSignIn;
document.getElementById('gcal-signout').onclick=gcalSignOut;
document.getElementById('gcal-refreshBtn').onclick=()=>{ if(gcal_calendar) gcal_calendar.refetchEvents(); refresh(); };
document.getElementById('gcal-status').textContent='未登录';

function gcalIsSignedIn(){ return !!gcal_accessToken; }
function currentWriteCalSummary(){ const meta=calendarListCache.find(c=>c.id===writeCalendarId); return meta ? meta.summary : writeCalendarId; }

async function gcalOnSignedIn(){
  document.getElementById('gcal-signin').style.display='none';
  document.getElementById('gcal-signout').style.display='';
  document.getElementById('gcal-refreshBtn').style.display='';
  document.getElementById('gcal-status').textContent='已登录';

  try{
    const res=await gapi.client.calendar.calendarList.list({maxResults:250});
    calendarListCache=(res.result.items||[]);

    const writeSel=document.getElementById('gcal-writeCal'); writeSel.innerHTML='';
    const writable=calendarListCache.filter(c=>c.accessRole==='owner'||c.accessRole==='writer');
    for(const cal of writable){
      const opt=document.createElement('option');
      opt.value=cal.id; opt.textContent=cal.summary+(cal.primary?" (primary)":"");
      writeSel.appendChild(opt);
    }
    const primary=writable.find(c=>c.primary);
    writeCalendarId=primary?primary.id:(writable[0]?.id||'primary');
    writeSel.value=writeCalendarId;
    document.getElementById('gcal-currCal').textContent=writeCalendarId;
    writeSel.style.display='';
    writeSel.onchange=()=>{ writeCalendarId=writeSel.value; document.getElementById('gcal-currCal').textContent=writeCalendarId; refresh(); };

    const picker=document.getElementById('gcal-picker');
    const listDiv=document.getElementById('gcal-calList');
    const legend=document.getElementById('gcal-legend');
    listDiv.innerHTML=''; legend.innerHTML='';
    showCalendarIds=new Set(calendarListCache.map(c=>c.id));
    for(const cal of calendarListCache){
      const wrap=document.createElement('label'); wrap.className='item';
      const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=true; cb.value=cal.id;
      cb.onchange=()=>{ if(cb.checked) showCalendarIds.add(cal.id); else showCalendarIds.delete(cal.id); if(gcal_calendar) gcal_calendar.refetchEvents(); };
      const sw=document.createElement('span'); sw.className='sw'; sw.style.background=cal.backgroundColor||'#bbb';
      const txt=document.createElement('span'); txt.textContent=cal.summary+(cal.accessRole==='reader'?'（只读）':'');
      wrap.appendChild(cb); wrap.appendChild(sw); wrap.appendChild(txt); listDiv.appendChild(wrap);

      const pill=document.createElement('span'); pill.className='pill';
      const sw2=document.createElement('span'); sw2.className='sw'; sw2.style.background=cal.backgroundColor||'#bbb';
      const name=document.createElement('span'); name.textContent=cal.summary;
      pill.appendChild(sw2); pill.appendChild(name); legend.appendChild(pill);
    }
    picker.style.display='';

    document.getElementById('gcal-checkAll').onclick=()=>{ showCalendarIds=new Set(calendarListCache.map(c=>c.id)); listDiv.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.checked=true); if(gcal_calendar) gcal_calendar.refetchEvents(); };
    document.getElementById('gcal-uncheckAll').onclick=()=>{ showCalendarIds=new Set(); listDiv.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.checked=false); if(gcal_calendar) gcal_calendar.refetchEvents(); };

  }catch(e){ gcalShowDiag(e); }

  gcalRenderCalendar();
}

function gcalRenderCalendar(){
  const el=document.getElementById('gcal-calendar'); if(gcal_calendar) gcal_calendar.destroy();

  gcal_calendar=new FullCalendar.Calendar(el,{
    initialView:'timeGridWeek',
    timeZone:GCAL_TZ,
    firstDay:1,
    slotMinTime:"08:00:00",
    slotMaxTime:"23:59:59",
    scrollTime:"08:00:00",
    slotLabelFormat:{hour:'2-digit',minute:'2-digit',hour12:false},
    selectable:true,
    editable:true,
    nowIndicator:true,
    eventMaxStack:50,
    headerToolbar:{ left:'prev,next today', center:'title', right:'dayGridMonth,timeGridWeek,timeGridDay' },

    events: async (info, success, failure)=>{
      try{
        const timeMinISO=new Date(info.start.getTime()-GCAL_FETCH_BUFFER_MS).toISOString();
        const timeMaxISO=new Date(info.end.getTime()+GCAL_FETCH_BUFFER_MS).toISOString();
        const ids=(showCalendarIds.size?Array.from(showCalendarIds):[writeCalendarId]);

        const fetchOne=async(cid)=>{
          const res=await gapi.client.calendar.events.list({
            calendarId:cid, timeMin:timeMinISO, timeMax:timeMaxISO,
            singleEvents:true, orderBy:'startTime', showDeleted:false, maxResults:2500,
          });
          const meta=calendarListCache.find(x=>x.id===cid);
          const color=meta?.backgroundColor;
          const canEdit=meta && (meta.accessRole==='owner'||meta.accessRole==='writer');

          return (res.result.items||[]).map(ev=>({
            id:(ev.id||Math.random().toString(36).slice(2))+'::'+cid,
            title:ev.summary||'(无标题)',
            start:ev.start.dateTime||ev.start.date,
            end:ev.end?.dateTime||ev.end?.date,
            allDay:!!ev.start.date,
            backgroundColor:color, borderColor:color,
            extendedProps:{calendarId:cid, eventId:ev.id, canEdit}
          }));
        };

        const chunks=await Promise.all(ids.map(cid=>fetchOne(cid)));
        success(chunks.flat());
      }catch(err){ gcalShowDiag(err); failure(err); }
    },

    eventAllow:(dropInfo, draggedEvent)=>{
      const canEdit=draggedEvent.extendedProps?.canEdit;
      if(!canEdit){ alert('这是只读日历的事件，不能编辑。'); return false; }
      return true;
    },

    select: async (selInfo)=>{
      if(!gcalIsSignedIn()) return;
      const title=prompt('事件标题：','新事件');
      if(!title){ gcal_calendar.unselect(); return; }
      const isAllDay=selInfo.allDay;
      const resource={
        summary:title,
        start:isAllDay?{date:selInfo.startStr}:{dateTime:selInfo.startStr,timeZone:GCAL_TZ},
        end: isAllDay?{date:selInfo.endStr}:{dateTime:selInfo.endStr,timeZone:GCAL_TZ},
      };
      try{
        const res=await gapi.client.calendar.events.insert({calendarId:writeCalendarId, resource});
        const meta=calendarListCache.find(x=>x.id===writeCalendarId);
        const color=meta?.backgroundColor;
        if(showCalendarIds.has(writeCalendarId)){
          gcal_calendar.addEvent({
            id:(res.result.id||Math.random().toString(36).slice(2))+'::'+writeCalendarId,
            title:res.result.summary||'(无标题)',
            start:res.result.start.dateTime||res.result.start.date,
            end:res.result.end?.dateTime||res.result.end?.date,
            allDay:!!res.result.start.date,
            backgroundColor:color, borderColor:color,
            extendedProps:{calendarId:writeCalendarId, eventId:res.result.id, canEdit:true}
          });
        }
      }catch(e){ gcalShowDiag(e); alert('创建失败：'+(e.result?.error?.message||e.message)); }
    },

    eventChange: async (chg)=>{
      const e=chg.event;
      const {calendarId,eventId,canEdit}=e.extendedProps||{};
      if(!canEdit){ chg.revert(); return; }
      try{
        await gapi.client.calendar.events.update({
          calendarId,eventId,
          resource:{
            summary:e.title,
            start:e.allDay?{date:e.startStr}:{dateTime:e.start.toISOString(),timeZone:GCAL_TZ},
            end: e.allDay?{date:e.endStr}:{dateTime:e.end?.toISOString(),timeZone:GCAL_TZ},
          }
        });
      }catch(err){ gcalShowDiag(err); alert('更新失败，已回滚：'+(err.result?.error?.message||err.message)); chg.revert(); }
    },

    eventClick: async (clickInfo)=>{
      const {calendarId,eventId,canEdit}=clickInfo.event.extendedProps||{};
      if(!canEdit){ alert('这是只读日历的事件，不能删除。'); return; }
      if(!confirm('删除这个事件？')) return;
      try{
        await gapi.client.calendar.events.delete({calendarId,eventId});
        clickInfo.event.remove();
        gcal_calendar.refetchEvents();
      }catch(err){ gcalShowDiag(err); alert('删除失败：'+(err.result?.error?.message||err.message)); }
    }
  });

  gcal_calendar.render();
}

/* 登录后自动显示（若已存 token） */
window.addEventListener('load', ()=>{
  const t = coachToken();
  if (t){
    refresh();
    const btnL = document.getElementById('btnLogout'); if(btnL) btnL.style.display='';
  }
});
</script>

<script>
/* =========================
   3) 改时间弹窗逻辑（含 24h 限制）
========================= */
let RS_SESSION=null;
function fillHourSel(id){ const sel=document.getElementById(id); if(sel.options.length) return; for(let h=8;h<=23;h++){ const v=String(h).padStart(2,'0'); sel.add(new Option(v,v)); } }
['rsH1','rsH2','rsH3','rsH4','rsH5'].forEach(fillHourSel);

function openRescheduleDialog(s){
  // 24 小时内禁止发起
  const now = new Date();
  const {start} = sessionStartEnd(s);
  if (start && (start - now) / 3600000 <= 24){
    alert('距离开始≤24小时，不可发起改时间');
    return;
  }
  RS_SESSION = s;
  document.getElementById('rsSid').textContent = `session_id: ${s.session_id}`;
  ['D1','D2','D3','D4','D5'].forEach(k=>document.getElementById('rs'+k).value='');
  ['H1','H2','H3','H4','H5'].forEach(k=>document.getElementById('rs'+k).value='08');
  ['M1','M2','M3','M4','M5'].forEach(k=>document.getElementById('rs'+k).value='00');
  document.getElementById('rsReason').value='';
  document.getElementById('rsDlg').style.display='flex';
}
function closeRs(){ document.getElementById('rsDlg').style.display='none'; RS_SESSION=null; }

async function submitReschedule(){
  const reason = document.getElementById('rsReason').value;
  if (!reason) return alert('请选择原因');

  const opts=[];
  for (let i=1;i<=5;i++){
    const d = document.getElementById('rsD'+i).value;
    const h = document.getElementById('rsH'+i).value;
    const m = document.getElementById('rsM'+i).value;
    if (d && h){ opts.push({date:d, time:`${h}:${m}`}); }
  }
  if (opts.length===0) return alert('请至少给出一个可选时间');

  const r = await post('propose_reschedule', {
    session_id: RS_SESSION.session_id,
    reason,
    options: opts
  });
  if (!r.ok){ alert(r.msg||'提交失败'); return; }
  closeRs();
  alert('已提交改时间，等待学员确认');
  refresh();
}
</script>
</body>
</html>
