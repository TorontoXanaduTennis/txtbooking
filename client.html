<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>客户端 · TXT 订课</title>
<style>
  :root{
    --bg:#f6f7fb; --card:#fff; --text:#111; --muted:#6b7280; --bdr:#e5e7eb;
    --shadow:0 10px 28px rgba(0,0,0,.08);
    --primary:#111; --green:#10b981; --red:#ef4444; --blue:#2563eb; --gray:#6b7280; --deep:#374151;
    --radius:14px;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
  .wrap{max-width:980px;margin:28px auto;padding:0 16px}
  h1{font-size:28px;margin:0 0 16px}
  .card{background:var(--card);border:1px solid var(--bdr);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;margin-bottom:18px}
  .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  input,select,button,textarea{padding:10px 12px;border:1px solid var(--bdr);border-radius:10px;background:#fff}
  button{background:var(--primary);color:#fff;cursor:pointer}
  .btn{padding:10px 14px;border-radius:10px;border:1px solid transparent}
  .btn.blue{background:var(--blue)}
  .btn.gray{background:var(--gray)}
  .btn.red{background:var(--red)}
  .btn.ok{background:var(--green)}
  .btn.lock{background:#86efac;color:#064e3b}
  .muted{color:var(--muted)}
  .pill{display:inline-block;padding:6px 12px;border:1px solid var(--bdr);border-radius:999px;background:#fff}

  .section{border:2px solid var(--deep);border-radius:16px;background:#fff;overflow:hidden}
  .section-inner{padding:12px}
  .pattern{height:10px;background:
      repeating-linear-gradient(135deg,#4b5563 0 8px,rgba(75,85,99,0) 8px 16px),
      repeating-linear-gradient(225deg,#4b5563 0 8px,rgba(75,85,99,0) 8px 16px);opacity:.45}

  .table-wrap{position:relative;overflow:auto;padding-top:6px}
  table{min-width:1000px;width:100%;table-layout:fixed;border-collapse:separate;border-spacing:0 10px}
  thead th{position:sticky;top:0;background:var(--bg);z-index:1;font-weight:600;padding:10px}
  tbody tr{background:#fff;box-shadow:var(--shadow)}
  th,td{padding:10px 12px;font-size:14px;vertical-align:middle;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  tbody tr td:first-child{border-top-left-radius:12px;border-bottom-left-radius:12px}
  tbody tr td:last-child{border-top-right-radius:12px;border-bottom-right-radius:12px}
  .row-input{width:100%}
  .w-date{width:160px} .w-time{width:90px} .w-dur{width:80px} .w-coach{width:140px}
  .w-status{width:100px} .w-note,.w-fb{width:260px} .w-act{width:120px} .w-id{width:180px}

  .progress-wrap{margin-top:8px;background:#e5e7eb;border-radius:999px;box-shadow:inset 0 2px 6px rgba(0,0,0,.12);height:12px}
  .progress-bar{height:100%;border-radius:999px;background:linear-gradient(90deg,#34d399,#10b981);box-shadow:0 2px 6px rgba(16,185,129,.35)}
  .num-green{color:var(--green);font-weight:700}
  .num-gray{color:var(--gray);font-weight:700}
  .renew-row{display:flex;justify-content:flex-end;margin-top:10px}
  .disabled{opacity:.55;pointer-events:none}
</style>
</head>
<body>
<div class="wrap">
  <h1>客户端 · TXT 订课</h1>

  <!-- 登录 -->
  <div class="card" id="loginCard">
    <div id="loginForm">
      <h3>登录</h3>
      <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px">
        <input id="name"  autocomplete="name"        placeholder="姓名（必填）" />
        <input id="email" autocomplete="email"       placeholder="邮箱（与电话二选一）" />
        <input id="phone" autocomplete="tel"         placeholder="电话（与邮箱二选一）" />
        <input id="password" autocomplete="current-password" placeholder="登录密码（必填）" type="password" />
        <button id="loginBtn" class="btn blue" onclick="login()" style="grid-column:1/2">登录</button>
      </div>
      <div class="muted" style="margin-top:6px;font-size:12px">必须输入：<b>姓名</b> + <b>邮箱或电话</b> + <b>登录密码</b>。</div>
    </div>

    <div id="userBar" style="display:none;align-items:center;justify-content:space-between" class="toolbar">
      <div id="userInfo" style="color:#10b981"></div>
      <div class="toolbar">
        <button class="btn" onclick="reloadAfterLogin()">刷新页面</button>
        <button class="btn red" onclick="logout()">退出登录</button>
      </div>
    </div>
  </div>

  <!-- 套餐 -->
  <div id="pkgCard" class="card" style="display:none">
    <h3>我的套餐</h3>
    <div id="pkgs" class="muted">（登录后显示）</div>
  </div>

  <!-- 课程进度 + 我要续课 -->
  <div id="progressCard" class="card" style="display:none">
    <h3>我的课程进度</h3>
    <div id="progressText" class="muted"></div>
    <div class="progress-wrap"><div id="progressBar" class="progress-bar" style="width:0%"></div></div>
    <div class="renew-row">
      <button class="btn blue" onclick="requestRenew()">我要续课</button>
    </div>
  </div>

  <!-- 预约 -->
  <div id="dash" class="card" style="display:none">
    <h3>预约上课</h3>
    <div class="toolbar" style="flex-wrap:wrap;gap:10px">
      <select id="pkgSel" title="选择套餐"></select>
      <input id="date" type="date" title="上课日期" />
      <div class="toolbar" style="gap:6px">
        <select id="hourSel" title="小时"></select>
        <span class="muted">:</span>
        <select id="minSel" title="分钟"><option value="00">00</option><option value="30">30</option></select>
      </div>
      <span class="pill" id="coachPill" title="指定教练"></span>
      <select id="durSel" title="时长">
        <option value="1">1 hr</option><option value="1.5">1.5 hr</option>
        <option value="2">2 hr</option><option value="2.5">2.5 hr</option>
        <option value="3">3 hr</option><option value="3.5">3.5 hr</option>
        <option value="4">4 hr</option>
      </select>
      <input id="notes" placeholder="备注（可选）" style="min-width:220px" />
      <button class="btn" onclick="createSession()">提交预约（待确认）</button>
    </div>
    <div id="bookMsg" class="muted" style="margin-top:6px"></div>
  </div>

  <!-- 即将到来的课程（scheduled） -->
  <div id="secUpcoming" class="section" style="display:none">
    <div class="pattern"></div>
    <div class="section-inner">
      <h3>即将到来的课程</h3>
      <div class="muted" style="margin:6px 0">10 天内</div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th class="w-date">date</th><th class="w-time">time</th><th class="w-dur">duration</th><th class="w-coach">coach</th>
              <th class="w-status">status</th><th class="w-note">备注</th><th class="w-fb">反馈</th><th class="w-act">提交</th><th class="w-id">session_id</th>
            </tr>
          </thead>
          <tbody id="tbUpcomingSoon"></tbody>
        </table>
      </div>
      <div style="height:10px"></div>
      <div class="muted" style="margin:6px 0">超过 10 天</div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th class="w-date">date</th><th class="w-time">time</th><th class="w-dur">duration</th><th class="w-coach">coach</th>
              <th class="w-status">status</th><th class="w-note">备注</th><th class="w-fb">反馈</th><th class="w-act">提交</th><th class="w-id">session_id</th>
            </tr>
          </thead>
          <tbody id="tbUpcomingLater"></tbody>
        </table>
      </div>
    </div>
    <div class="pattern"></div>
  </div>

  <div style="height:16px"></div>

  <!-- 待改时间（Reschedule Proposals） -->
  <div id="secReschedule" class="section" style="display:none">
    <div class="pattern"></div>
    <div class="section-inner">
      <h3>待改时间</h3>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th class="w-id">proposal_id</th>
              <th>原 session_id</th>
              <th>原因</th>
              <th class="w-act">选择</th>
            </tr>
          </thead>
          <tbody id="tbRes"></tbody>
        </table>
      </div>
      <div class="muted" style="margin-top:6px">可选择其中一个或多个备选时间；提交后会生成新的待确认课程。</div>
    </div>
    <div class="pattern"></div>
  </div>

  <div style="height:16px"></div>

  <!-- 待确认（pending） -->
  <div id="secPending" class="section" style="display:none">
    <div class="pattern"></div>
    <div class="section-inner">
      <h3>待确认课程</h3>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th class="w-date">date</th><th class="w-time">time</th><th class="w-dur">duration</th><th class="w-coach">coach</th>
              <th class="w-status">status</th><th class="w-note">备注</th><th class="w-fb">反馈</th><th class="w-act">提交</th><th class="w-id">session_id</th>
            </tr>
          </thead>
          <tbody id="tbPending"></tbody>
        </table>
      </div>
    </div>
    <div class="pattern"></div>
  </div>

  <div style="height:16px"></div>

  <!-- 已完成（done，10条/页） -->
  <div id="secDone" class="section" style="display:none">
    <div class="pattern"></div>
    <div class="section-inner">
      <h3 style="display:flex;justify-content:space-between;align-items:center">
        <span>已完成课程</span>
        <span class="toolbar">
          <button class="btn gray" id="donePrev" onclick="pageDone(-1)">上一页</button>
          <span id="donePageInfo" class="muted"></span>
          <button class="btn gray" id="doneNext" onclick="pageDone(1)">下一页</button>
        </span>
      </h3>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th class="w-date">date</th><th class="w-time">time</th><th class="w-dur">duration</th><th class="w-coach">coach</th>
              <th class="w-status">status</th><th class="w-note">备注</th><th class="w-fb">反馈</th><th class="w-act">提交</th><th class="w-id">session_id</th>
            </tr>
          </thead>
          <tbody id="tbDone"></tbody>
        </table>
      </div>
    </div>
    <div class="pattern"></div>
  </div>
</div>

<script>
/* === Apps Script /exec === */
const API_BASE = 'https://script.google.com/macros/s/AKfycbxgSxWqIJD4WpiPGeaf6HSERs4YZz-H60p43Izcvc0wQAh7Jhev4LYRIK3dPiz-qehMWw/exec';

function saveSession(u){ localStorage.setItem('TXT_CLIENT', JSON.stringify(u||{})); }
function readSession(){ try{ return JSON.parse(localStorage.getItem('TXT_CLIENT')||'{}'); }catch(e){return{}} }

async function post(action, payload = {}) {
  try {
    const cache = readSession();
    if (action !== 'login_client' && cache){
      if (!('client_id' in payload) && cache.client_id) payload.client_id = cache.client_id;
      if (!('client_key' in payload) && cache.password)  payload.client_key = cache.password;
      if (!('password'  in payload) && cache.password)  payload.password  = cache.password;
      if (!('email'     in payload) && cache.email)     payload.email     = cache.email;
      if (!('phone'     in payload) && cache.phone)     payload.phone     = cache.phone;
    }
    const res = await fetch(API_BASE, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify({ action, ...payload })
    });
    const txt = await res.text();
    try { return JSON.parse(txt); } catch { return { ok:/\"ok\"\s*:\s*true/.test(txt) }; }
  } catch (err) {
    console.error('POST error', err);
    return { ok:false, msg:'Network error' };
  }
}

/* ==== 日期/时间 ==== */
const isDate = v => Object.prototype.toString.call(v)==='[object Date]' && !isNaN(v);
function parseMaybeDate(x){
  if (x==null || x==='') return null;
  if (isDate(x)) return x;
  if (typeof x==='number'){ const base=Date.UTC(1899,11,30); return new Date(base + x*86400000); }
  if (typeof x==='string'){
    if (/^\d{1,2}:\d{2}/.test(x)){ const [h,m]=x.split(':').map(Number); const d=new Date(); d.setHours(h,m||0,0,0); return d; }
    const d = new Date(x); if(!isNaN(d)) return d;
  }
  return null;
}
function weekdayCN(d){ return ['周日','周一','周二','周三','周四','周五','周六'][d.getDay()]; }
function fmtDate(x){ const d=parseMaybeDate(x); return d?`${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}（${weekdayCN(d)}）`:(x||''); }
function fmtTime(x){ const d=parseMaybeDate(x); return d?d.toTimeString().slice(0,5):(x||''); }
function startDT(s){
  const d = parseMaybeDate(s.date), t = parseMaybeDate(s.time);
  if(!d || !t) return null;
  return new Date(d.getFullYear(), d.getMonth(), d.getDate(), t.getHours(), t.getMinutes(), 0, 0);
}

/* ==== 登录/状态 ==== */
let client=null; let PACKS=[]; let SESS=[]; let RESC=[];
const TEN = 10*24*3600*1000;
const DONE_LOCKS = new Set(JSON.parse(localStorage.getItem('TXT_DONE_LOCKS')||'[]'));
function saveLocks(){ localStorage.setItem('TXT_DONE_LOCKS', JSON.stringify([...DONE_LOCKS])); }

function setLoginUI(logged){
  loginForm.style.display = logged ? 'none' : 'block';
  userBar.style.display   = logged ? 'flex' : 'none';
  pkgCard.style.display   = logged ? 'block': 'none';
  progressCard.style.display = logged ? 'block' : 'none';
  dash.style.display      = logged ? 'block': 'none';
  secUpcoming.style.display = logged ? 'block' : 'none';
  secPending.style.display  = logged ? 'block' : 'none';
  secDone.style.display     = logged ? 'block' : 'none';
  secReschedule.style.display = logged ? 'block' : 'none';
}
function logout(){
  client=null; saveSession(null); setLoginUI(false); bookMsg.textContent='';
  ['name','email','phone','password'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
}
async function reloadAfterLogin(){
  const cache = readSession();
  if (!cache || (!cache.email && !cache.phone) || !cache.password){ alert('请先登录'); return; }
  const r = await post('login_client', { email: cache.email||'', phone: cache.phone||'', password: cache.password });
  if (r.ok) await afterLogin(r); else alert(r.msg||'刷新失败');
}

async function login(){
  const btn = document.getElementById('loginBtn'); btn.disabled = true;
  try{
    const name = nameEl.value.trim(), email = emailEl.value.trim(), phone = phoneEl.value.trim(), password = passwordEl.value.trim();
    if (!name) { alert('请填写姓名'); return; }
    if (!email && !phone){ alert('邮箱与电话需至少填写一个'); return; }
    if (!password){ alert('请填写登录密码'); return; }
    const r = await post('login_client', { email, phone, password });
    if(!r.ok){ alert(r.msg || '登录失败'); return; }
    if (r.client && r.client.name){
      const a=String(r.client.name).trim().toLowerCase(), b=name.toLowerCase().trim();
      if (a!==b){ alert('姓名与账号不匹配'); return; }
    }
    saveSession({client_id:r.client.client_id, email:r.client.email||email, phone:r.client.phone||phone, name:r.client.name, password});
    await afterLogin(r);
  } finally { btn.disabled = false; }
}

function renderProgress(){
  const done = PACKS.reduce((s,p)=>s+(Number(p.total_hours||0)-Number(p.remaining_hours||0)),0);
  const remain = PACKS.reduce((s,p)=>s+Number(p.remaining_hours||0),0);
  const total = done + remain;
  progressText.innerHTML = `已完成 <span class="num-green">${done}</span> 小时 · 待上 <span class="num-gray">${remain}</span> 小时`;
  const pct = total>0 ? Math.min(100, Math.max(0, Math.round((done/total)*100))) : 0;
  progressBar.style.width = pct + '%';
}
function requestRenew(){
  alert('请直接与TXT客服联系进行续课\n微信号：TorontoXanaduTennis\n邮箱：info@torontoxanadutennis.com');
}

async function afterLogin(data){
  client = data.client; PACKS = data.packages||[]; SESS = data.sessions||[]; RESC = data.reschedules||[];
  userInfo.textContent = `${client.name}（${client.client_id}）已登录`;
  setLoginUI(true);

  pkgs.innerHTML =
    (PACKS||[]).map(p =>
      `• ${p.package_name} [${p.package_id}]：总 <span class="num-green">${p.total_hours}</span> 小时 / 剩余 <span style="color:#ef4444;font-weight:700">${p.remaining_hours}</span> 小时`
    ).join('<br/>') || '<span class="muted">暂无套餐</span>';

  renderProgress();

  pkgSel.innerHTML = (PACKS||[]).map(p=>`<option value="${p.package_id}">${p.package_name} [${p.package_id}]</option>`).join('');

  coachPill.textContent = `您的教练：${client.coach_name || '未指定教练'}`;
  coachPill.dataset.coachId = client.coach_id || '';

  const today = new Date(); const y=today.getFullYear(), m=String(today.getMonth()+1).padStart(2,'0'), d=String(today.getDate()).padStart(2,'0');
  date.min = `${y}-${m}-${d}`; if (!date.value) date.value = date.min;

  if (hourSel.options.length === 0){ for(let h=8; h<=23; h++){ const v=String(h).padStart(2,'0'); hourSel.add(new Option(v,v)); } }
  const now=new Date(); let H=Math.max(8, now.getHours()); let M=now.getMinutes()<30?'30':'00'; if (M==='00') H=Math.min(23,H+1);
  hourSel.value=String(Math.min(Math.max(H,8),23)).padStart(2,'0'); minSel.value=M;

  renderUpcoming();
  renderPending();
  renderReschedules();
  prepareDone();
}

/* ==== 预约 ==== */
function composeTimeStr(){ return `${hourSel.value||'08'}:${minSel.value||'00'}`; }
function isPastSelection(dateStr, timeStr){ const sel=new Date(`${dateStr}T${timeStr}:00`); return sel.getTime() < Date.now() - 60*1000; }
async function createSession(){
  if(!client){ alert('请先登录'); return; }
  const package_id = pkgSel.value, dateStr = date.value, timeStr = composeTimeStr();
  const duration_hours = Number(durSel.value); const notes = notesEl.value.trim();
  const coach_id = coachPill.dataset.coachId || '';
  if(!package_id){ alert('请选择套餐'); return; }
  if(!dateStr){ alert('请选择日期'); return; }
  if (isPastSelection(dateStr, timeStr)){ alert('不能选择已过去的时间'); return; }
  const r = await post('create_session', { package_id, date: dateStr, time: timeStr, duration_hours, notes, coach_id });
  if(!r.ok){ bookMsg.style.color='var(--red)'; bookMsg.textContent='预约失败：' + (r.msg||'Unknown error'); }
  else{ bookMsg.style.color='var(--green)'; bookMsg.textContent='预约成功，等待教练确认'; reloadAfterLogin(); }
}

/* ==== 行模板 & 渲染（与你现有一致） ==== */
function rowHTML(s, locked){
  const sid = s.session_id;
  const note = (s.notes||'').replace(/"/g,'&quot;');
  const fb   = (s.feedback||'').replace(/"/g,'&quot;');
  const dis = locked ? 'disabled' : '';
  return `
    <td class="w-date">${fmtDate(s.date)}</td>
    <td class="w-time">${fmtTime(s.time)}</td>
    <td class="w-dur">${s.duration_hours||1} hr</td>
    <td class="w-coach">${s.coach_name||''}</td>
    <td class="w-status">${s.status||''}</td>
    <td class="w-note"><input class="row-input note" ${dis} data-id="${sid}" value="${note}"></td>
    <td class="w-fb"><input class="row-input fb" ${dis} data-id="${sid}" value="${fb}"></td>
    <td class="w-act"><button class="btn ${locked?'lock':''}" ${locked?'disabled':''} onclick="submitRow('${sid}','${s.status}')">${locked?'已提交':'提交'}</button></td>
    <td class="w-id">${sid}</td>
  `;
}

function renderUpcoming(){
  const soonTB = document.getElementById('tbUpcomingSoon');
  const laterTB= document.getElementById('tbUpcomingLater');
  soonTB.innerHTML = ''; laterTB.innerHTML = '';
  const now = Date.now();

  const list = (SESS||[]).filter(x=>x.status==='scheduled')
    .sort((a,b)=>{
      const sa=startDT(a), sb=startDT(b);
      const da = sa?sa.getTime():Number.MAX_SAFE_INTEGER;
      const db = sb?sb.getTime():Number.MAX_SAFE_INTEGER;
      return da-db;
    });

  list.forEach(s=>{
    const st=startDT(s); const isSoon=!st||(st.getTime()-now)<=TEN;
    const tr=document.createElement('tr'); tr.innerHTML=rowHTML(s,false);
    (isSoon?soonTB:laterTB).appendChild(tr);
  });

  secUpcoming.style.display='block';
}

function renderPending(){
  const tb = document.getElementById('tbPending'); tb.innerHTML='';
  const createdKey = ['created_at','createdAt','created','created_time'].find(k=>SESS.some(s=>s[k]!=null));
  const list = (SESS||[]).filter(x=>x.status==='pending')
    .sort((a,b)=>{
      const ca = createdKey ? parseMaybeDate(a[createdKey]) : startDT(a);
      const cb = createdKey ? parseMaybeDate(b[createdKey]) : startDT(b);
      return (ca?ca.getTime():0) - (cb?cb.getTime():0);
    });
  list.forEach(s=>{ const tr=document.createElement('tr'); tr.innerHTML=rowHTML(s,false); tb.appendChild(tr); });
  secPending.style.display='block';
}

/* ==== 待改时间渲染 ==== */
function renderReschedules(){
  const tb = document.getElementById('tbRes'); tb.innerHTML='';

  if (!Array.isArray(RESC) || RESC.length===0){
    tb.innerHTML = `<tr><td colspan="4" class="muted">暂无待改时间提议</td></tr>`;
    return;
  }

  RESC.forEach(p=>{
    const opts=[];
    for(let i=1;i<=5;i++){
      const d=p['opt'+i+'_date'], t=p['opt'+i+'_time'];
      if(d && t) opts.push({i,label:`${d} ${t}`});
    }
    const id = p.proposal_id;
    const row = document.createElement('tr');
    row.innerHTML = `
      <td class="w-id">${id}</td>
      <td>${p.session_id}</td>
      <td>${p.reason==='coach_conflict'?'教练时间冲突':p.reason==='court_conflict'?'场地时间冲突':(p.reason||'')}</td>
      <td class="w-act" id="cell-${id}">
        ${opts.map(o=>`<label style="display:inline-flex;align-items:center;gap:6px;margin-right:8px">
          <input type="checkbox" data-prop="${id}" value="${o.i}"><span>${o.label}</span>
        </label>`).join('')}
        <button class="btn" style="margin-left:6px" onclick="submitResChoices('${id}')">提交选择</button>
      </td>
    `;
    tb.appendChild(row);
  });

  secReschedule.style.display='block';
}

async function submitResChoices(pid){
  const cell = document.getElementById(`cell-${pid}`);
  const checks = [...cell.querySelectorAll(`input[type="checkbox"][data-prop="${pid}"]:checked`)];
  if (checks.length===0){ alert('请至少选择一个备选时间'); return; }
  const idx = checks.map(c=>Number(c.value));
  const r = await post('client_choose_reschedule', { proposal_id: pid, selected_indices: idx });
  if (!r.ok){ alert(r.msg||'提交失败'); return; }
  alert('已提交，系统已生成新的待确认课程');
  reloadAfterLogin();
}

/* ==== 已完成（分页 10 条/页） ==== */
let DONE_LIST=[]; let donePage=1; const donePageSize=10;
function prepareDone(){
  DONE_LIST = (SESS||[]).filter(x=>x.status==='done')
    .sort((a,b)=>{ const sa=startDT(a), sb=startDT(b); return (sb?sb.getTime():0)-(sa?sa.getTime():0); });
  donePage=1; renderDonePaged();
}
function pageDone(delta){
  const totalPages=Math.max(1,Math.ceil(DONE_LIST.length/donePageSize));
  donePage=Math.min(totalPages,Math.max(1,donePage+delta));
  renderDonePaged();
}
function renderDonePaged(){
  const totalPages=Math.max(1,Math.ceil(DONE_LIST.length/donePageSize));
  const s=(donePage-1)*donePageSize, e=s+donePageSize;
  const page = DONE_LIST.slice(s,e);

  const tb=document.getElementById('tbDone'); tb.innerHTML='';
  page.forEach(s=>{
    const locked = DONE_LOCKS.has(s.session_id);
    const tr=document.createElement('tr'); tr.innerHTML=rowHTML(s,locked); tb.appendChild(tr);
  });

  donePageInfo.textContent = `第 ${donePage} / 共 ${totalPages} 页（每页 10）`;
  donePrev.disabled = donePage<=1; doneNext.disabled = donePage>=totalPages;
  secDone.style.display='block';
}

/* ==== 备注/反馈（与你现有相同） ==== */
async function updateNotesCompat(base){
  const actions = [
    'update_session_notes','update_session_feedback','update_notes','update_feedback',
    'update_session','update_session_v2','update_session_fields','update_session_meta',
    'save_session','set_session','set_session_fields','update_session_info',
    'client_update_session','client_update_notes',
    'client_set_session','client_save_session',
    'mutate_session','patch_session','edit_session_notes','set_session_notes','save_session_notes'
  ];
  const idKeys   = ['session_id','id','sid'];
  const noteKeys = ['notes','client_notes','note','remark'];
  const fbKeys   = ['feedback','client_feedback','fb',''];
  const shapes = [
    (p, idk, nk, fk) => Object.assign({ [idk]:p.session_id, [nk]:p.notes }, fk?{[fk]:p.feedback}:{}) ,
    (p, idk, nk, fk) => { const fields=Object.assign({[nk]:p.notes}, fk?{[fk]:p.feedback}:{});
      return { [idk]:p.session_id, fields }; },
    (p, idk, nk, fk) => { const data=Object.assign({[idk]:p.session_id, [nk]:p.notes}, fk?{[fk]:p.feedback}:{});
      return { data }; },
    (p, idk, nk, fk) => { const updates=Object.assign({[nk]:p.notes}, fk?{[fk]:p.feedback}:{});
      return { [idk]:p.session_id, updates }; },
    (p, idk, nk, fk) => { const patch=Object.assign({[nk]:p.notes}, fk?{[fk]:p.feedback}:{});
      return { [idk]:p.session_id, patch }; },
    (p, idk, nk, fk) => { const session=Object.assign({[idk]:p.session_id, [nk]:p.notes}, fk?{[fk]:p.feedback}:{});
      return { session }; }
  ];
  for (const act of actions){
    for (const idk of idKeys){
      for (const nk of noteKeys){
        for (const fk of fbKeys){
          for (const build of shapes){
            const payload = build(base, idk, nk, fk);
            payload.action = act;
            payload.source = 'client_ui';
            const r = await post(act, payload);
            if (r && r.ok) return r;
          }
        }
      }
    }
  }
  return { ok:false, msg:'All tries failed' };
}

async function submitRow(id, status){
  const noteEl = document.querySelector(`.note[data-id='${id}']`);
  const fbEl   = document.querySelector(`.fb[data-id='${id}']`);
  const btn    = document.querySelector(`button.btn[onclick*="${id}"]`);
  const notes = noteEl ? noteEl.value : '';
  const feedback = fbEl ? fbEl.value : '';

  btn.disabled = true;
  const r = await updateNotesCompat({ session_id:id, notes, feedback });
  btn.disabled = false;

  if(!r.ok){
    btn.textContent='提交失败';
    btn.classList.remove('ok'); btn.classList.add('red');
    setTimeout(()=>{btn.textContent=(status==='done'?'已提交':'提交');btn.classList.remove('red')},1400);
    return;
  }

  btn.textContent='提交成功';
  btn.classList.add('ok');
  setTimeout(()=>{btn.textContent=(status==='done'?'已提交':'提交');btn.classList.remove('ok')},1000);

  if (status==='done'){
    DONE_LOCKS.add(id); saveLocks();
    if (noteEl) { noteEl.disabled=true; noteEl.classList.add('disabled'); }
    if (fbEl)   { fbEl.disabled=true;  fbEl.classList.add('disabled'); }
    btn.classList.add('lock'); btn.disabled=true;
  }
}

/* ==== 元素引用 ==== */
const nameEl = document.getElementById('name');
const emailEl = document.getElementById('email');
const phoneEl = document.getElementById('phone');
const passwordEl = document.getElementById('password');
const hourSel = document.getElementById('hourSel');
const minSel  = document.getElementById('minSel');
const date    = document.getElementById('date');
const pkgSel  = document.getElementById('pkgSel');
const coachPill = document.getElementById('coachPill');
const durSel  = document.getElementById('durSel');
const notesEl = document.getElementById('notes');
const loginForm = document.getElementById('loginForm');
const userBar   = document.getElementById('userBar');
const pkgs      = document.getElementById('pkgs');
const pkgCard   = document.getElementById('pkgCard');
const progressCard = document.getElementById('progressCard');
const progressText = document.getElementById('progressText');
const progressBar  = document.getElementById('progressBar');
const dash      = document.getElementById('dash');
const secUpcoming = document.getElementById('secUpcoming');
const secPending  = document.getElementById('secPending');
const secDone     = document.getElementById('secDone');
const secReschedule = document.getElementById('secReschedule');
const bookMsg   = document.getElementById('bookMsg');
const userInfo  = document.getElementById('userInfo');

/* ==== 启动：尝试自动恢复登录 ==== */
(async function init(){
  const cache = readSession();
  if (cache && (cache.email || cache.phone) && cache.password){
    const rel = await post('login_client', { email: cache.email||'', phone: cache.phone||'', password: cache.password });
    if (rel.ok){ await afterLogin(rel); return; }
  }
  setLoginUI(false);
})();
</script>
</body>
</html>
