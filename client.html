<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>客户端 · TXT 订课</title>
<style>
:root{
  --bg:#f6f7fb; --card:#fff; --text:#111; --muted:#6b7280; --bdr:#e5e7eb;
  --shadow:0 8px 20px rgba(0,0,0,.08);
  --success:#10b981; --danger:#ef4444; --primary:#111; --blue:#2563eb; --orange:#f59e0b; --gray:#6b7280; --deep:#374151;
  --st-pending:#FEF3C7; --st-scheduled:#E5E7EB; --st-done:#D1FAE5; --st-cancel:#FECACA;
  --radius:14px;
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
.wrap{max-width:1100px;margin:28px auto;padding:0 16px}
h1{font-size:26px;margin:0 0 16px}
.card{background:var(--card);border:1px solid var(--bdr);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;margin-bottom:18px}
.toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
input,select,button{padding:10px 12px;border:1px solid var(--bdr);border-radius:10px;background:#fff}
button{background:var(--primary);color:#fff;cursor:pointer}
.btn{padding:8px 12px;border-radius:10px;border:1px solid transparent}
.btn.success{background:var(--success)}
.btn.danger{background:var(--danger)}
.btn.blue{background:var(--blue)}
.btn.orange{background:var(--orange)}
.btn.gray{background:var(--gray)}
.muted{color:var(--muted)}
.small{font-size:12px}
.badge{padding:2px 10px;border-radius:999px;font-size:12px;display:inline-block}
.b-pending{background:var(--st-pending);color:#92400e}
.b-scheduled{background:var(--st-scheduled);color:#374151}
.b-done{background:var(--st-done);color:#065f46}
.b-cancel{background:var(--st-cancel);color:#991B1B}
.table-wrap{position:relative;overflow:auto}
table{width:100%;border-collapse:separate;border-spacing:0 10px}
thead th{position:sticky;top:0;background:var(--bg);z-index:1;font-weight:600;padding:10px}
tbody tr{background:#fff;box-shadow:var(--shadow)}
th,td{padding:10px 12px;font-size:14px;vertical-align:middle;white-space:nowrap}
tbody tr td:first-child{border-top-left-radius:12px;border-bottom-left-radius:12px}
tbody tr td:last-child{border-top-right-radius:12px;border-bottom-right-radius:12px}
.note-red{color:#b91c1c;line-height:1.5}
.hr{height:10px;background:repeating-linear-gradient(135deg,#4b5563 0 8px,transparent 8px 16px),
                    repeating-linear-gradient(225deg,#4b5563 0 8px,transparent 8px 16px);
    border-radius:6px;opacity:.35;margin:12px 0}
.msg{margin-top:8px}
.msg.ok{color:var(--success)}
.msg.err{color:var(--danger)}
#refreshHint{margin-left:8px}
</style>

<!-- Google 身份登录（GSI） -->
<script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
<div class="wrap">
  <h1>客户端 · TXT 订课</h1>

  <!-- ===== 登录页 ===== -->
  <div id="loginPane" class="card" style="display:none;">
    <h3>登录</h3>
    <p class="muted">请使用被授权的 Google 账号登录</p>
    <div id="gsiBtn" style="margin:12px 0;"></div>
    <div id="loginMsg" class="muted small"></div>
  </div>

  <!-- ===== 应用页（登录后） ===== -->
  <div id="appPane" style="display:none;">
    <div class="card">
      <div class="toolbar">
        <span class="muted">已登录：<b id="meEmail">-</b></span>
        <button class="btn" onclick="loadEverything()">刷新列表</button>
        <button class="btn orange" onclick="softReload()">刷新页面</button>
        <button class="btn gray" onclick="signOutClient()">退出登录</button>
        <span id="refreshHint" class="muted"></span>
      </div>
      <div class="small muted" id="whoAmI"></div>
    </div>

    <!-- 我的套餐（含注意事项） -->
    <div class="card">
      <h3>我的套餐</h3>
      <div class="note-red">
        <div>1）系统处理较慢，所有操作请点击一次后等待完整操作，再进行新的操作。</div>
        <div>2）所有课程 24 小时内取消会导致扣除该课程 50% 的费用。课程开始前 2 小时内无法取消课程，因任何个人原因缺席本节课将视作 no show，扣除本节课 100% 课时。</div>
        <div>3）报名后建议保持提交 3 节课或以上待确认。</div>
      </div>
      <div class="hr"></div>
      <div id="pkgList"></div>
    </div>

    <!-- 预约课程 -->
    <div class="card">
      <h3>预约课程</h3>
      <div class="toolbar" style="gap:12px">
        <select id="book_pkg"></select>
        <input id="book_date" type="date" />
        <input id="book_time" type="time" />
        <select id="book_dur">
          <option value="1">1 小时</option>
          <option value="1.5">1.5 小时</option>
          <option value="2">2 小时</option>
        </select>
        <input id="book_notes" placeholder="备注（可选）" style="min-width:220px" />
        <button class="btn blue" onclick="createSession()">提交预约</button>
      </div>
      <div id="bookMsg" class="msg"></div>
    </div>

    <!-- 我的课程 -->
    <div class="card">
      <h3>我的课程</h3>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <!-- 按要求：不显示创建时间，但排序保持（在 JS 内按创建/开始时间排序） -->
              <th>date</th><th>time</th><th>coach</th>
              <th>package</th><th>duration</th><th>status</th><th>备注</th><th style="width:200px">操作</th>
            </tr>
          </thead>
          <tbody id="tbodyPending"></tbody>
          <tbody id="tbodyScheduled"></tbody>
          <tbody id="tbodyDone"></tbody>
          <tbody id="tbodyCanceled"></tbody>
        </table>
      </div>
      <div id="listMsg" class="msg"></div>
    </div>

    <!-- 临时取消（24h 内）& No Show 列表（展示用） -->
    <div class="card">
      <h3>临时取消（24h 内） & No Show（仅展示）</h3>
      <div class="small muted" style="margin-bottom:6px">说明：仅用于查看记录，不可操作；“临时取消”基于时间推断与备注识别，供参考。</div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr><th>类型</th><th>date</th><th>time</th><th>coach</th><th>package</th><th>duration</th><th>备注</th></tr>
          </thead>
          <tbody id="tbodyLateAndNoShow"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
/* =========================
  常量 & 简工具
========================= */
const API_BASE = 'https://script.google.com/macros/s/AKfycbzIRAc4FhAGl_v-1m59lbHg4zl5Kth6z-1TIuM4en2CS0i8fBV26b5Gi-c0wNL1LPawyA/exec';
const CLIENT_TOKEN_KEY = 'TXT_CLIENT_ID_TOKEN';
const CLIENT_GOOGLE_CLIENT_ID = "126117723960-3gdibqblicp6ncc0jiuv9pu8frgmhs5n.apps.googleusercontent.com";

function setRefreshing(on, msg){
  const el = document.getElementById('refreshHint');
  if(!el) return;
  if(on){ el.style.color='var(--orange)'; el.textContent = msg || '正在刷新…'; }
  else { el.style.color='var(--success)'; el.textContent = msg || '刷新已完成'; setTimeout(()=>{ if(el.textContent==='刷新已完成') el.textContent=''; }, 1200); }
}
function clientToken(){ return localStorage.getItem(CLIENT_TOKEN_KEY)||''; }
function setClientToken(t){ if(t) localStorage.setItem(CLIENT_TOKEN_KEY, t); }
function clearClientToken(){ localStorage.removeItem(CLIENT_TOKEN_KEY); }
function softReload(){ loadEverything(); }

async function post(action, payload={}){
  const t = clientToken();
  if(t && !payload.id_token) payload.id_token = t;
  try{
    const res = await fetch(API_BASE,{ method:'POST', headers:{'Content-Type':'text/plain'}, body: JSON.stringify({action, ...payload}) });
    return await res.json();
  }catch(e){
    console.error(e); return { ok:false, msg:'Network error' };
  }
}

/* =========================
  登录流程（Google）
  使用 login_client_google，后端会把 assigned_coach 映射为 coach_id/coach_name
========================= */
let ME=null, PACKAGES=[], SESSIONS=[], RESCHEDULES=[];
function showLogin(msg){
  document.getElementById('loginPane').style.display='';
  document.getElementById('appPane').style.display='none';
  if(msg) document.getElementById('loginMsg').textContent = msg;
  renderGsi();
}
function showApp(){
  document.getElementById('loginPane').style.display='none';
  document.getElementById('appPane').style.display='';
}

async function ensureSignedIn(){
  const t = clientToken();
  if(!t){ showLogin(); return; }
  const r = await post('login_client_google', { id_token: t });
  if(r && r.ok){
    // 成功：合并数据
    ME = r.client || {};
    PACKAGES = r.packages || [];
    SESSIONS = r.sessions || [];
    RESCHEDULES = r.reschedules || [];
    showApp();
    document.getElementById('meEmail').textContent = ME.email || '-';
    renderHeaderInfo();
    await loadEverything();
  }else{
    clearClientToken(); showLogin('登录失效，请重新登录。');
  }
}
function signOutClient(){ clearClientToken(); location.reload(); }

function renderGsi(){
  if(!window.google || !google.accounts || !google.accounts.id) return;
  google.accounts.id.initialize({
    client_id: CLIENT_GOOGLE_CLIENT_ID,
    callback: async (resp)=>{
      const idt = resp && resp.credential;
      if(!idt){ showLogin('未获取到登录凭据'); return; }
      const r = await post('login_client_google', { id_token: idt });
      if(r && r.ok){
        setClientToken(idt);
        ME = r.client||{};
        PACKAGES = r.packages||[];
        SESSIONS = r.sessions||[];
        RESCHEDULES = r.reschedules||[];
        showApp();
        document.getElementById('meEmail').textContent = ME.email || '-';
        renderHeaderInfo();
        await loadEverything();
      }else{
        showLogin(r && r.msg ? ('登录失败：'+r.msg) : '登录失败');
      }
    },
    auto_select:false
  });
  google.accounts.id.renderButton(document.getElementById('gsiBtn'), { theme:'outline', size:'large', type:'standard', width:280 });
}

function renderHeaderInfo(){
  const who = document.getElementById('whoAmI');
  const cname = ME.name || ME.client_name || ME.full_name || '';
  const cid = ME.client_id || '';
  const coachName = ME.coach_name || '';
  const coachId = ME.coach_id || '';
  const coachLabel = (coachName?coachName:'未指定教练') + (coachId?`（${coachId}）`:'');
  who.textContent = `学员：${cname}${cid?`（${cid}）`:''} ｜ 固定教练：${coachLabel}`;
}

/* =========================
  加载 / 渲染
========================= */
function isDate(d){ return Object.prototype.toString.call(d)==='[object Date]' && !isNaN(d); }
function parseMaybeDate(x){
  if (x==null || x==='') return null;
  if (x instanceof Date && !isNaN(x)) return x;
  if (typeof x==='number'){ if (x < 1e11){ const base=Date.UTC(1899,11,30); return new Date(base + x*86400000);} return new Date(x); }
  if (typeof x==='string'){
    const s=x.trim();
    if(/^\d{1,2}:\d{2}(:\d{2})?$/.test(s)){ const [h,m]=s.split(':').map(Number); const d=new Date(); d.setHours(h||0,m||0,0,0); return d; }
    if(/^\d{10,13}$/.test(s)){ const n=Number(s); return new Date(s.length===10? n*1000:n); }
    const m1=s.match(/^(\d{4}[\/-]\d{1,2}[\/-]\d{1,2})[ T](\d{1,2}:\d{2}(:\d{2})?)$/);
    if(m1){ const ds=m1[1].replace(/\//g,'-'); return new Date(ds+'T'+m1[2]); }
    const d=new Date(s); if(!isNaN(d)) return d;
  }
  return null;
}
function fmtDate(x){ const d=parseMaybeDate(x); return d?d.toLocaleDateString('zh-CN',{year:'numeric',month:'2-digit',day:'2-digit'}):(x||''); }
function fmtTime(x){ const d=parseMaybeDate(x); return d?d.toLocaleTimeString('zh-CN',{hour12:false,hour:'2-digit',minute:'2-digit'}):(x||''); }
function startDT(row, idx){ const d=parseMaybeDate(row[idx.date]); const t=parseMaybeDate(row[idx.time]); if(!d||!t) return null; return new Date(d.getFullYear(),d.getMonth(),d.getDate(),t.getHours(),t.getMinutes(),0,0); }

function badge(status){
  if(status==='done') return '<span class="badge b-done">done</span>';
  if(status==='scheduled') return '<span class="badge b-scheduled">scheduled</span>';
  if(status==='pending') return '<span class="badge b-pending">pending</span>';
  if(status==='canceled_by_client'||status==='cancelled') return '<span class="badge b-cancel">canceled</span>';
  return status||'';
}

function idxOf(H, names){ for (const n of names){ const i=H.indexOf(n); if(i!==-1) return i; } return -1; }

async function loadEverything(){
  if(!ME || !ME.client_id){ return; }
  try{
    setRefreshing(true,'正在刷新…');
    // 重新登录一次拉取最新数据（避免“操作后必须重新登录才能看到”的问题）
    const r = await post('login_client_google', { id_token: clientToken() });
    if(r && r.ok){
      ME = r.client||ME;
      PACKAGES = r.packages||[];
      SESSIONS = r.sessions||[];
      RESCHEDULES = r.reschedules||[];
      renderHeaderInfo();
      renderPackages();
      renderSessions();
      renderLateAndNoShow();
      setRefreshing(false,'刷新已完成');
      document.getElementById('listMsg').textContent='';
    }else{
      setRefreshing(false,'刷新失败'); document.getElementById('listMsg').textContent = '刷新失败：' + (r && r.msg || '');
      document.getElementById('listMsg').className = 'msg err';
    }
  }catch(e){
    console.error(e); setRefreshing(false,'刷新失败');
    const m = document.getElementById('listMsg'); m.textContent = '刷新失败：' + e.message; m.className='msg err';
  }
}

function renderPackages(){
  const box = document.getElementById('pkgList');
  if(!PACKAGES.length){ box.innerHTML = '<div class="muted">暂无套餐</div>'; }
  else{
    box.innerHTML = PACKAGES.map(p=>{
      const pname = p.package_name || p.package || '(未命名套餐)';
      const rest = `总 ${p.total_hours||''} / 剩余 ${p.remaining_hours||''}`;
      const pid = p.package_id || '';
      return `<div style="padding:10px 12px;border:1px solid var(--bdr);border-radius:12px;margin:8px 0;background:#fff">
        <div><b>${pname}</b> <span class="muted">[${pid}] · ${rest}</span></div>
      </div>`;
    }).join('');
  }
  // 预约选择
  const sel = document.getElementById('book_pkg');
  sel.innerHTML = (PACKAGES||[]).map(p=>`<option value="${p.package_id}">${(p.package_name||p.package||'(未命名)')} [${p.package_id}]</option>`).join('') || '<option value="">无可用套餐</option>';
}

function renderSessions(){
  const tbP = document.getElementById('tbodyPending');
  const tbS = document.getElementById('tbodyScheduled');
  const tbD = document.getElementById('tbodyDone');
  const tbC = document.getElementById('tbodyCanceled');
  tbP.innerHTML = tbS.innerHTML = tbD.innerHTML = tbC.innerHTML = '';

  if(!Array.isArray(SESSIONS) || !SESSIONS.length){
    tbP.innerHTML = `<tr><td colspan="8" class="muted">暂无课程</td></tr>`;
    return;
  }

  // 生成索引
  const headers = Object.keys(SESSIONS[0]||{});
  const H = headers; const idx = Object.fromEntries(H.map((h,i)=>[h,i]));
  // 用数组形式统一访问
  const rows = SESSIONS.map(obj=> H.map(k=>obj[k]));

  // 排序：先按创建时间（若有）否则按开始日期
  const cIdx = idxOf(H, ['created_at','created_time','created','createdAt','createdAtUtc']);
  rows.sort((a,b)=>{
    const ad = cIdx!==-1 ? parseMaybeDate(a[cIdx]) : startDT({date:a[idx.date],time:a[idx.time]}, idx);
    const bd = cIdx!==-1 ? parseMaybeDate(b[cIdx]) : startDT({date:b[idx.date],time:b[idx.time]}, idx);
    return (ad?ad.getTime():0) - (bd?bd.getTime():0);
  });

  const addRow = (tb, row, status)=>{
    const coachLabel = ((row[idx.coach_name]||'') + (row[idx.coach_id]?`（${row[idx.coach_id]}）`:''));
    const pkgName = row[idx.package_name] || row[idx.package] || '';
    const sid = row[idx.session_id] || '';
    const actions = (status==='pending'||status==='scheduled')
      ? `<button class="btn danger" onclick="cancelMySession('${sid}')">取消</button>`
      : '';
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${fmtDate(row[idx.date])}</td>
      <td>${fmtTime(row[idx.time])}</td>
      <td>${coachLabel||'—'}</td>
      <td>${pkgName||'—'}</td>
      <td>${row[idx.duration_hours]||1}</td>
      <td>${badge(status)}</td>
      <td>${row[idx.notes]||''}</td>
      <td>${actions}</td>`;
    tb.appendChild(tr);
  };

  rows.forEach(r=>{
    const st = String(r[idx.status]||'');
    if (st==='pending') addRow(tbP, r, st);
    else if (st==='scheduled') addRow(tbS, r, st);
  });

  // done / canceled
  rows.forEach(r=>{
    const st = String(r[idx.status]||'');
    if (st==='done') addRow(tbD, r, st);
    if (st==='canceled_by_client' || st==='cancelled') addRow(tbC, r, 'cancelled');
  });

  if(!tbP.children.length) tbP.innerHTML = `<tr><td colspan="8" class="muted">无待确认</td></tr>`;
  if(!tbS.children.length) tbS.innerHTML = `<tr><td colspan="8" class="muted">无已排期</td></tr>`;
  if(!tbD.children.length) tbD.innerHTML = `<tr><td colspan="8" class="muted">无已完成</td></tr>`;
  if(!tbC.children.length) tbC.innerHTML = `<tr><td colspan="8" class="muted">无已取消</td></tr>`;
}

function renderLateAndNoShow(){
  const tb = document.getElementById('tbodyLateAndNoShow');
  tb.innerHTML = '';
  if(!Array.isArray(SESSIONS) || !SESSIONS.length){
    tb.innerHTML = `<tr><td colspan="7" class="muted">暂无记录</td></tr>`;
    return;
  }
  const H = Object.keys(SESSIONS[0]||{});
  const idx = Object.fromEntries(H.map((h,i)=>[h,i]));
  const rows = SESSIONS.map(o=>H.map(k=>o[k]));

  const now = Date.now();
  let items = [];

  rows.forEach(r=>{
    const status = String(r[idx.status]||'');
    const dt = startDT({date:r[idx.date], time:r[idx.time]}, idx);
    const coachLabel = ((r[idx.coach_name]||'') + (r[idx.coach_id]?`（${r[idx.coach_id]}）`:''));
    const pkgName = r[idx.package_name] || r[idx.package] || '';
    const dur = r[idx.duration_hours] || 1;
    const note = r[idx.notes] || '';

    // 识别 no-show：done 且备注出现关键词
    const text = (note||'').toLowerCase();
    const isNoShow = status==='done' && ( /no\s*show|noshow|缺席|未到|未出席/.test(text) );

    // 识别“临时取消（推断）”：标记为 canceled_by_client，且离开始时间小于 24 小时（以当前时间粗略推断，仅供参考）
    const isLateCancel = (status==='canceled_by_client'||status==='cancelled') && dt && (Math.abs(dt.getTime() - now) <= 24*3600*1000);

    if(isNoShow){
      items.push({type:'No Show', date:r[idx.date], time:r[idx.time], coach:coachLabel, pkg:pkgName, dur, note});
    }else if(isLateCancel){
      items.push({type:'临时取消(推断)', date:r[idx.date], time:r[idx.time], coach:coachLabel, pkg:pkgName, dur, note});
    }
  });

  if(!items.length){
    tb.innerHTML = `<tr><td colspan="7" class="muted">暂无识别到的“临时取消 / No Show”记录</td></tr>`;
    return;
  }
  items.sort((a,b)=>{
    const da = parseMaybeDate(fmtDate(a.date)+' '+fmtTime(a.time)) || new Date(0);
    const db = parseMaybeDate(fmtDate(b.date)+' '+fmtTime(b.time)) || new Date(0);
    return db - da;
  });
  items.forEach(it=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${it.type}</td>
      <td>${fmtDate(it.date)}</td>
      <td>${fmtTime(it.time)}</td>
      <td>${it.coach||'—'}</td>
      <td>${it.pkg||'—'}</td>
      <td>${it.dur||1}</td>
      <td>${it.note||''}</td>`;
    tb.appendChild(tr);
  });
}

/* =========================
  操作：预约 / 取消
========================= */
async function createSession(){
  if(!ME || !ME.client_id){ return; }
  const pkg = document.getElementById('book_pkg').value;
  const date = document.getElementById('book_date').value;
  const time = document.getElementById('book_time').value;
  const duration_hours = Number(document.getElementById('book_dur').value || 1);
  const notes = document.getElementById('book_notes').value.trim();
  const msg = document.getElementById('bookMsg');

  if(!pkg){ msg.className='msg err'; msg.textContent='请选择套餐'; return; }
  if(!date || !time){ msg.className='msg err'; msg.textContent='请选择日期与时间'; return; }

  const payload = {
    package_id: pkg,
    client_id: ME.client_id,
    coach_id: ME.coach_id || '', // 若指定教练，后端会写入
    date, time, duration_hours, notes
  };
  const r = await post('create_session', payload);
  if(r && r.ok){
    msg.className='msg ok';
    msg.textContent='提交成功，等待确认';
    await loadEverything(); // 立刻刷新，不需要重新登录
  }else{
    msg.className='msg err';
    msg.textContent='提交失败：' + (r && r.msg || 'Network error');
  }
}

/* 取消课程（按后端规则：>24h 免费；2–24h 扣 50%；<2h 禁止） */
async function cancelMySession(session_id){
  if(!ME || !ME.client_id) return;
  if(!confirm('确认取消该课程？（开始前2小时内不可取消；2–24小时内取消将扣除该课程50%时长）')) return;
  const r = await post('client_cancel_session', { session_id, client_id: ME.client_id });
  const m = document.getElementById('listMsg');
  if(r && r.ok){
    m.className='msg ok';
    // 后端会返回 penalty_hours；若已调整为“扣一半”，这里会如实显示
    if (typeof r.penalty_hours !== 'undefined'){
      m.textContent = `已取消成功${r.penalty_hours>0?`（扣除 ${r.penalty_hours} 小时）`:''}`;
    }else{
      m.textContent = '已取消成功';
    }
    await loadEverything(); // 立刻刷新
  }else{
    m.className='msg err';
    m.textContent = '取消失败：' + (r && r.msg || 'Network error');
  }
}

/* =========================
  启动
========================= */
window.addEventListener('load', ()=>{ ensureSignedIn(); });
</script>
</body>
</html>
