<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>客户端 · TXT 订课</title>
<style>
  :root{
    --bg:#f6f7fb; --card:#fff; --text:#111; --muted:#6b7280; --bdr:#e5e7eb;
    --shadow:0 10px 28px rgba(0,0,0,.08);
    --primary:#111; --green:#10b981; --red:#ef4444; --blue:#2563eb; --gray:#6b7280;
    --radius:14px;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
  .wrap{max-width:980px;margin:28px auto;padding:0 16px}
  h1{font-size:28px;margin:0 0 16px}
  .card{background:var(--card);border:1px solid var(--bdr);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;margin-bottom:18px}
  .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  input,select,button,textarea{padding:10px 12px;border:1px solid var(--bdr);border-radius:10px;background:#fff}
  button{background:var(--primary);color:#fff;cursor:pointer}
  .btn{padding:10px 14px;border-radius:10px;border:1px solid transparent}
  .btn.blue{background:var(--blue)}
  .btn.gray{background:var(--gray)}
  .btn.red{background:var(--red)}
  .muted{color:var(--muted)}
  .pill{display:inline-block;padding:4px 10px;border:1px solid var(--bdr);border-radius:999px;background:#fff}
  .num-green{color:var(--green);font-weight:700}
  .num-red{color:var(--red);font-weight:700}

  /* 表格：固定列宽 + 横向滚动，避免挤压 */
  .table-wrap{position:relative;overflow:auto;padding-top:6px}
  table{min-width:1200px;width:100%;table-layout:fixed;border-collapse:separate;border-spacing:0 10px}
  thead th{position:sticky;top:0;background:var(--bg);z-index:1;font-weight:600;padding:10px}
  tbody tr{background:#fff;box-shadow:var(--shadow)}
  th,td{padding:10px 12px;font-size:14px;vertical-align:middle;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  tbody tr td:first-child{border-top-left-radius:12px;border-bottom-left-radius:12px}
  tbody tr td:last-child{border-top-right-radius:12px;border-bottom-right-radius:12px}
  .row-input{width:100%}

  .w-id{width:180px}.w-date{width:120px}.w-time{width:90px}.w-dur{width:90px}
  .w-coach{width:140px}.w-status{width:110px}.w-note,.w-fb{width:260px}.w-act{width:74px}
</style>
</head>
<body>
<div class="wrap">
  <h1>客户端 · TXT 订课</h1>

  <!-- 登录 / 用户条（不显示 API） -->
  <div class="card" id="loginCard">
    <div id="loginForm">
      <h3>登录</h3>
      <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px">
        <input id="name" placeholder="姓名（必填）" />
        <input id="email" placeholder="邮箱（与电话二选一）" />
        <input id="phone" placeholder="电话（与邮箱二选一）" />
        <input id="password" placeholder="登录密码（必填）" type="password" />
        <button id="loginBtn" class="btn blue" onclick="login()" style="grid-column:1/3">登录</button>
      </div>
      <div class="muted" style="margin-top:6px;font-size:12px">必须输入：<b>姓名</b> + <b>邮箱或电话</b> + <b>登录密码</b>。</div>
    </div>

    <div id="userBar" style="display:none;align-items:center;justify-content:space-between" class="toolbar">
      <div id="userInfo" style="color:var(--green)"></div>
      <div class="toolbar">
        <button class="btn" onclick="refreshDashboard()">刷新页面</button>
        <button class="btn red" onclick="logout()">退出登录</button>
      </div>
    </div>
  </div>

  <!-- 预约区 -->
  <div id="dash" class="card" style="display:none">
    <h3>我的套餐</h3>
    <div id="pkgs" class="muted">（登录后显示）</div>

    <h3 style="margin-top:16px">预约上课</h3>
    <div class="toolbar" style="flex-wrap:wrap;gap:10px">
      <select id="pkgSel" title="选择套餐"></select>
      <input id="date" type="date" title="上课日期" />
      <div class="toolbar" style="gap:6px">
        <select id="hourSel" title="小时"></select>
        <span class="muted">:</span>
        <select id="minSel" title="分钟"><option value="00">00</option><option value="30">30</option></select>
      </div>
      <span class="pill" id="coachPill" title="指定教练"></span>
      <select id="durSel" title="时长">
        <option value="1">1 hr</option><option value="1.5">1.5 hr</option>
        <option value="2">2 hr</option><option value="2.5">2.5 hr</option>
        <option value="3">3 hr</option><option value="3.5">3.5 hr</option>
        <option value="4">4 hr</option>
      </select>
      <input id="notes" placeholder="备注（可选）" style="min-width:220px" />
      <button class="btn" onclick="createSession()">提交预约（待确认）</button>
    </div>
    <div id="bookMsg" class="muted" style="margin-top:6px"></div>
  </div>

  <!-- 上课记录 -->
  <div id="sess" class="card" style="display:none">
    <h3>我的上课记录</h3>
    <div class="table-wrap">
      <table id="sessTbl">
        <thead>
          <tr>
            <th class="w-id">session_id</th>
            <th class="w-date">date</th>
            <th class="w-time">time</th>
            <th class="w-dur">duration</th>
            <th class="w-coach">coach</th>
            <th class="w-status">status</th>
            <th class="w-note">备注</th>
            <th class="w-fb">反馈</th>
            <th class="w-act">保存</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<script>
// === Apps Script /exec ===
const API_BASE = 'https://script.google.com/macros/s/AKfycbzvN9lgnxywjnVTw5E39DSfsWH09dsCE3bwOUbrVP5vbjoBom7Oh_wFHOKlHpkxixW8Ew/exec';

/* -------- 基础网络 -------- */
async function post(action, payload = {}) {
  try {
    const res = await fetch(API_BASE, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify({ action, ...payload })
    });
    return await res.json();
  } catch (err) {
    console.error('POST error', err);
    alert('网络错误：' + err.message);
    return { ok:false, msg:'Network error' };
  }
}

/* -------- 日期/时间工具 -------- */
const isDate = v => Object.prototype.toString.call(v)==='[object Date]' && !isNaN(v);
function parseMaybeDate(x){
  if (x==null || x==='') return null;
  if (isDate(x)) return x;
  if (typeof x==='number'){ const base = Date.UTC(1899,11,30); return new Date(base + x*86400000); }
  if (typeof x==='string'){
    if (/^\d{1,2}:\d{2}/.test(x)){ const [h,m]=x.split(':').map(Number); const d=new Date(); d.setHours(h,m||0,0,0); return d; }
    const d = new Date(x); if(!isNaN(d)) return d;
  }
  return null;
}
function fmtDate(x){ const d=parseMaybeDate(x); return d?d.toLocaleDateString('zh-CN',{year:'numeric',month:'2-digit',day:'2-digit'}):(x||''); }
function fmtTime(x){ const d=parseMaybeDate(x); return d?d.toLocaleTimeString('zh-CN',{hour12:false,hour:'2-digit',minute:'2-digit'}):(x||''); }
function getStartDT(s){
  const d = parseMaybeDate(s.date);
  const t = parseMaybeDate(s.time);
  if(!d || !t) return null;
  return new Date(d.getFullYear(), d.getMonth(), d.getDate(), t.getHours(), t.getMinutes(), 0, 0);
}
function getEndDT(s){
  const st = getStartDT(s);
  if(!st) return null;
  return new Date(st.getTime() + Number(s.duration_hours||1)*3600*1000);
}

/* -------- 本地存储：会话与凭据 -------- */
let client = null;
function saveSession(u){ localStorage.setItem('TXT_CLIENT', JSON.stringify(u||{})); }
function readSession(){ try{ return JSON.parse(localStorage.getItem('TXT_CLIENT')||'{}'); }catch(e){return{}} }

function saveAuth(a){ localStorage.setItem('TXT_CLIENT_AUTH',
